<!DOCTYPE html>
<html>
<head>
    <title>修正后的集合定义测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .expected { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>修正后的集合定义测试</h1>
    <div id="results"></div>

    <script src="js/fileStorage.js"></script>
    <script src="js/ruleEngine.js"></script>
    <script>
        const ruleEngine = new RuleEngine();
        const results = document.getElementById('results');

        // 测试用例
        const testCases = [
            // 应该成功的情况
            { input: 'N1==A', expected: 'success', desc: '单大写字母集合名引用' },
            { input: 'N2==(A)', expected: 'success', desc: '单大写字母集合名括号形式' },
            { input: 'N3==(ShortV)', expected: 'success', desc: '多字母集合名括号形式' },
            { input: 'N4=={a,b,c}', expected: 'success', desc: '大括号字面集合' },
            { input: 'N5=={"hello","world"}', expected: 'success', desc: '大括号内带引号字面值（保持引号）' },
            { input: 'N6=="abc"', expected: 'success', desc: '双引号字面字符串' },
            
            // 应该失败的情况
            { input: 'N7==x', expected: 'error', desc: '小写字母集合名（不允许）' },
            { input: 'N8==xy', expected: 'error', desc: '多字母无括号（不允许）' },
            { input: 'N9==XY', expected: 'error', desc: '多大写字母无括号（不允许）' },
            { input: 'N10==Xy', expected: 'error', desc: '混合大小写无括号（不允许）' },
            { input: 'N11==(a)', expected: 'error', desc: '小写字母括号形式（不允许）' }
        ];

        // 先添加一些基础集合供引用
        const localSets = new Map();
        localSets.set('A', new Set(['a1', 'a2']));
        localSets.set('ShortV', new Set(['short1', 'short2']));

        testCases.forEach((testCase, index) => {
            const div = document.createElement('div');
            div.className = 'test-case';
            
            try {
                ruleEngine.parseSetDefinition(testCase.input, localSets);
                
                if (testCase.expected === 'success') {
                    div.className += ' success';
                    
                    // 显示解析结果
                    const setName = testCase.input.split('==')[0].trim();
                    const resultSet = localSets.get(setName);
                    const resultArray = resultSet ? Array.from(resultSet) : [];
                    
                    div.innerHTML = `<strong>✓ 测试 ${index + 1}:</strong> ${testCase.desc}<br>
                                   <strong>输入:</strong> ${testCase.input}<br>
                                   <strong>结果:</strong> 成功解析，集合内容: {${resultArray.join(', ')}}`;
                } else {
                    div.className += ' error';
                    div.innerHTML = `<strong>✗ 测试 ${index + 1}:</strong> ${testCase.desc}<br>
                                   <strong>输入:</strong> ${testCase.input}<br>
                                   <strong>结果:</strong> 意外成功（应该失败）`;
                }
            } catch (error) {
                if (testCase.expected === 'error') {
                    div.className += ' success';
                    div.innerHTML = `<strong>✓ 测试 ${index + 1}:</strong> ${testCase.desc}<br>
                                   <strong>输入:</strong> ${testCase.input}<br>
                                   <strong>结果:</strong> 正确拒绝 - ${error.message}`;
                } else {
                    div.className += ' error';
                    div.innerHTML = `<strong>✗ 测试 ${index + 1}:</strong> ${testCase.desc}<br>
                                   <strong>输入:</strong> ${testCase.input}<br>
                                   <strong>结果:</strong> 意外失败 - ${error.message}`;
                }
            }
            
            results.appendChild(div);
        });

        // 特别测试大括号内引号保留功能
        const specialDiv = document.createElement('div');
        specialDiv.className = 'test-case expected';
        specialDiv.innerHTML = '<strong>特别验证：大括号内引号保留</strong><br>';
        
        try {
            const testLocalSets = new Map();
            ruleEngine.parseSetDefinition('TestQuotes=={"hello",world,"test"}', testLocalSets);
            const testSet = testLocalSets.get('TestQuotes');
            const elements = Array.from(testSet);
            
            specialDiv.innerHTML += `解析结果: {${elements.join(', ')}}<br>`;
            specialDiv.innerHTML += `验证: "hello" 保持引号，world 无引号，"test" 保持引号`;
        } catch (error) {
            specialDiv.innerHTML += `错误: ${error.message}`;
        }
        
        results.appendChild(specialDiv);

        // 显示当前集合状态
        const statusDiv = document.createElement('div');
        statusDiv.className = 'test-case expected';
        statusDiv.innerHTML = `<strong>当前集合状态:</strong><br>`;
        for (const [name, set] of localSets) {
            statusDiv.innerHTML += `${name}: {${Array.from(set).join(', ')}}<br>`;
        }
        results.appendChild(statusDiv);
    </script>
</body>
</html>