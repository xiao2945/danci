<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§„åˆ™ç®¡ç† - å•è¯ç­›é€‰å·¥å…·</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .rule-manager-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .rule-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .rule-manager-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 60vh;
        }

        .rule-panels {
            display: flex;
            gap: 20px;
        }

        .rule-examples-panel {
            flex: 1;
            max-width: 50%;
            min-height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rule-editor-panel {
            flex: 1;
            max-width: 50%;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-title {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .rule-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            background: #f8fafc;
            transition: border-color 0.3s ease;
        }

        .rule-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .examples-header .panel-title {
            margin: 0;
        }

        .toggle-all-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toggle-all-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .toggle-all-btn:active {
            transform: translateY(0);
        }

        .example-section {
            margin-bottom: 0;
        }

        .example-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            transition: all 0.3s ease;
            user-select: none;
        }

        .example-title:hover {
            background: #e2e8f0;
            color: #2d3748;
        }

        .example-title::before {
            content: "ğŸ“";
            margin-right: 8px;
        }

        .example-title::after {
            content: "â–¼";
            margin-left: auto;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: #718096;
        }

        .example-section.collapsed .example-title::after {
            transform: rotate(-90deg);
        }

        .example-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }

        .example-section.collapsed .example-content {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .example-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            margin-bottom: 10px;
        }

        .example-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
            border-radius: 0 4px 4px 0;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .copy-btn:hover {
            opacity: 1;
        }

        .rule-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .saved-rules-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .saved-rules-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .saved-rules-header h2 {
            margin: 0;
        }

        .saved-rules-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            max-height: 500px;
            overflow-y: auto;
            padding: 0;
            min-height: 100px;
            background: transparent;
            border: none;
        }

        .saved-rules-container.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-30px);
        }

        .rule-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            overflow: hidden;
        }

        .rule-item-name {
            font-weight: 600;
            color: #2d3748;
            flex-shrink: 0;
        }

        .rule-item-content {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #718096;
            background: #e2e8f0;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: nowrap;
            margin-top: 8px;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .rule-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .syntax-help {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .syntax-help h4 {
            color: #c53030;
            margin-bottom: 10px;
        }

        .syntax-list {
            list-style: none;
            padding: 0;
        }

        .syntax-list li {
            padding: 5px 0;
            border-bottom: 1px solid #fed7d7;
        }

        .syntax-list li:last-child {
            border-bottom: none;
        }

        .syntax-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 3px;
            color: #2d3748;
        }

        .global-sets-editor {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .global-sets-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .global-sets-display {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .global-sets-display h4 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .global-sets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .global-set-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #93c5fd;
        }

        .rule-tree {
            list-style: none;
            padding: 0;
            margin: 0;
            font-family: 'Courier New', monospace;
        }

        .rule-tree-item {
            margin-bottom: 8px;
        }

        .rule-group {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .rule-group-header {
            background: #edf2f7;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        .rule-group-header:hover {
            background: #e2e8f0;
        }

        .rule-group-title {
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .rule-group-toggle {
            font-size: 12px;
            color: #718096;
            transition: transform 0.3s ease;
            width: 16px;
            text-align: center;
        }

        .rule-group.collapsed .rule-group-toggle {
            transform: rotate(-90deg);
        }

        .rule-group.expanded .rule-group-toggle {
            transform: rotate(90deg);
        }

        .rule-group-content {
            padding: 0;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .rule-group.collapsed .rule-group-content {
            max-height: 0;
        }

        .rule-group.expanded .rule-group-content {
            display: block;
        }

        .rule-sub-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background-color 0.3s ease;
            cursor: move;
        }

        .rule-sub-item:hover {
            background: #f8fafc;
        }

        .rule-sub-item:last-child {
            border-bottom: none;
        }

        .rule-sub-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .rule-sub-info {
            flex: 1;
        }

        .rule-sub-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .rule-sub-preview {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            color: #718096;
            background: #f1f5f9;
            padding: 4px 6px;
            border-radius: 3px;
        }

        .rule-sub-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .rule-sub-item:hover .rule-sub-actions {
            opacity: 1;
        }

        .drag-handle {
            color: #cbd5e0;
            cursor: move;
            margin-right: 8px;
            font-size: 14px;
        }

        .drag-handle:hover {
            color: #a0aec0;
        }

        @media (max-width: 1024px) {
            .rule-panels {
                flex-direction: column;
            }

            .rule-examples-panel,
            .rule-editor-panel {
                max-width: 100%;
                flex: none;
            }
        }

        @media (max-width: 768px) {
            .rule-manager-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .rule-actions {
                justify-content: center;
                flex-wrap: wrap;
            }

            .rule-panels {
                flex-direction: column;
                gap: 15px;
            }

            .rule-examples-panel,
            .rule-editor-panel {
                max-width: 100%;
                flex: none;
                min-height: auto;
            }

            .rule-textarea {
                min-height: 200px;
            }

            .global-sets-textarea {
                min-height: 120px;
            }
        }
    </style>
</head>

<body>
    <div class="rule-manager-container">
        <header class="rule-manager-header">
            <div>
                <h1>è§„åˆ™ç®¡ç†</h1>
                <p>åˆ›å»ºå’Œç®¡ç†å•è¯ç­›é€‰è§„åˆ™</p>
            </div>
            <div class="header-buttons">
                <button id="backToMainBtn" class="btn btn-help">è¿”å›ä¸»é¡µ</button>
            </div>
        </header>

        <!-- ä¸ŠåŠåŒºï¼šå·¦å³å¸ƒå±€ -->
        <div class="rule-manager-content">
            <div class="rule-panels">
                <!-- å·¦ä¾§ï¼šç¤ºä¾‹åŒºåŸŸ -->
                <div class="rule-examples-panel">
                    <div class="examples-header">
                        <h3 class="panel-title">è§„åˆ™ç¤ºä¾‹</h3>
                        <button class="toggle-all-btn" onclick="toggleAllExamples()" title="æ”¶ç¼©/å±•å¼€å…¨éƒ¨ç¤ºä¾‹">
                            <span class="toggle-all-text">æ”¶ç¼©å…¨éƒ¨</span>
                        </button>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">å››å­—æ¯åŠä»¥ä¸Šå•è¯</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#å››å­—æ¯åŠä»¥ä¸Šå•è¯</span></div>
                                    <div><span style="color: #63b3ed;">!LLLL</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…åŒ…å«å››ä¸ªæˆ–æ›´å¤šè¿ç»­å­—æ¯çš„å•è¯</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong>!LLLLï¼ˆéƒ¨åˆ†åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong>Lï¼ˆå…¨å±€é›†åˆï¼ŒåŒ…å«æ‰€æœ‰å­—æ¯a-zï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>æ’åºï¼š</strong>@ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæŒ‰å­—æ¯é¡ºåºæ’åºï¼›@-ï¼Œåˆ™è¡¨ç¤ºæŒ‰å­—æ¯é™åºæ’åˆ—</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>book, tree, jump, play, hello,
                                    world,
                                    beautiful, wonderful</div>
                                <div style="color: #666; font-size: 0.9em;">æ³¨ï¼šå¦‚éœ€æ°å¥½å››ä¸ªå­—æ¯ï¼Œè¯·ä½¿ç”¨<span
                                        style="color: red;">\b</span>LLLL<span style="color: red;">\e</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">åŸºç¡€CVCæ¨¡å¼</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVCæ¨¡å¼</span></div>
                                    <div><span style="color: #63b3ed;">!\bCVC\e</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³ç»“æ„çš„ä¸‰å­—æ¯å•è¯</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong>!\bCVC\eï¼ˆå®Œæ•´åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong>Cï¼ˆè¾…éŸ³ï¼‰ã€Vï¼ˆå…ƒéŸ³ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cat, dog, run, big, hat, pen, sit,
                                    cup
                                </div>
                                <div style="color: #666; font-size: 0.9em;">æ³¨ï¼š\bè¡¨ç¤ºå•è¯å¼€å¤´ï¼Œ\eè¡¨ç¤ºå•è¯ç»“å°¾</div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">CVCEæ¨¡å¼ï¼ˆé­”æ³•Eï¼‰</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVCEæ¨¡å¼</span></div>
                                    <div><span style="color: #63b3ed;">!\bCVC[e]\e</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³-eç»“æ„çš„å•è¯ï¼ˆé­”æ³•Eæ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong>!\bCVC[e]\eï¼ˆå®Œæ•´åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong>Cï¼ˆè¾…éŸ³ï¼‰ã€Vï¼ˆå…ƒéŸ³ï¼‰ã€<span
                                        style="color: red;">[e]è¡¨ç¤ºå­—é¢å­—ç¬¦e</span></div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cake, make, bike, home, cute, hope,
                                    time, name</div>
                                <div style="color: #666; font-size: 0.9em;">æ³¨ï¼šå½“æƒ³ä½¿ç”¨å­—é¢å­—ç¬¦æ—¶ï¼Œéœ€è¦ç”¨ä¸­æ‹¬å·[ ]ï¼Œå¦‚[e]ã€[tion]</div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">åŒè¾…éŸ³å¼€å¤´ï¼ˆéƒ¨åˆ†åŒ¹é…ï¼‰</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#åŒè¾…éŸ³å¼€å¤´</span></div>
                                    <div><span
                                            style="color: #ed64a6;">BL=={bl,br,cl,cr,dr,fl,fr,gl,gr,pl,pr,sc,sk,sl,sm,sn,sp,st,sw,tr,tw}</span>
                                    </div>
                                    <div><span style="color: #63b3ed;">!\b(BL)</span></div>
                                    <div><span style="color: #f6e05e;">@(BL)</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…ä»¥åŒè¾…éŸ³å¼€å¤´çš„å•è¯</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong>!\b(BL)ï¼ˆéƒ¨åˆ†åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;">
                                    <strong>é›†åˆï¼š</strong>BLï¼ˆå±€éƒ¨é›†åˆï¼ŒåŒ…å«bl,br,cl,cr,dr,fl,fr,gl,gr,pl,pr,sc,sk,sl,sm,sn,sp,st,sw,tr,twï¼‰
                                </div>
                                <div style="margin-bottom: 8px;"><strong>æ’åºï¼š</strong>æŒ‰é›†åˆBLåŒ…å«çš„å…ƒç´ æ’åº</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>black, brown, class, green, play,
                                    tree,
                                    stop, swim</div>
                                <div style="color: #666; font-size: 0.9em;">
                                    æ³¨ï¼š1ã€ä¸¤ä¸ªå­—æ¯ä»¥ä¸Šçš„é›†åˆéœ€ç”¨æ‹¬å·å¼•ç”¨ï¼Œå¦‚(BL)<br>2ã€å¯ä»¥åœ¨æ’åºï¼ˆBL)å‰æ·»åŠ -ï¼ˆå¦‚-ï¼ˆBLï¼‰ï¼‰è¡¨ç¤ºæŒ‰é›†åˆBLå†…çš„å…ƒç´ é€†åºæ’åˆ—ï¼›ä¹Ÿå¯ä»¥å¢åŠ å¤šä¸ªæ’åºå…³é”®å­—ï¼Œè¡¨ç¤ºæ¬¡çº§æ’åº
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)"><span style="color: red;">ç»„åˆè§„åˆ™</span>
                        </div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVCæˆ–CVCE</span></div>
                                    <div><span style="color: #63b3ed;">!!CVCæ¨¡å¼||CVCEæ¨¡å¼</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>ç»„åˆå¤šä¸ªè§„åˆ™ï¼ŒåŒ¹é…æ»¡è¶³CVCæ¨¡å¼æˆ–CVCEæ¨¡å¼çš„å•è¯</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong>!!CVCæ¨¡å¼||CVCEæ¨¡å¼ï¼ˆè§„åˆ™ç»„åˆæ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong>æ— ï¼ˆå¼•ç”¨å·²å®šä¹‰çš„è§„åˆ™ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cat, dog, run, big, cake, make,
                                    bike,
                                    home</div>
                                <div style="margin-bottom: 12px; color: #666; font-size: 0.9em;">æ³¨ï¼š!!è¡¨ç¤ºå¼•ç”¨å·²å®šä¹‰çš„è§„åˆ™</div>
                                <div style="margin-bottom: 8px;"><strong><span
                                            style="color: red;">æ”¯æŒçš„æ“ä½œç¬¦ï¼š</span></strong>
                                </div>
                                <div style="margin-left: 16px;">
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">&&</span> - é€»è¾‘ä¸ï¼ˆåŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼‰</div>
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">||</span> - é€»è¾‘æˆ–ï¼ˆæ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼‰</div>
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">--</span> - éæ¨¡å¼ï¼ˆæ»¡è¶³å‰è€…ä½†ä¸æ»¡è¶³åè€…ï¼‰</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§„åˆ™ç¼–è¾‘å™¨ -->
                <div class="rule-editor-panel">
                    <h3 class="panel-title">è§„åˆ™ç¼–è¾‘å™¨</h3>

                    <div class="syntax-help">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4>å¿«é€Ÿè¯­æ³•æç¤º</h4>
                            <button id="detailedHelpBtn" class="btn btn-help btn-small">è¯¦ç»†è¯­æ³•å¸®åŠ©</button>
                        </div>
                        <ul class="syntax-list">
                            <li><span class="syntax-code">#è§„åˆ™å</span> - å®šä¹‰è§„åˆ™åç§°ï¼ˆä»¥#å¼€å¤´ï¼‰</li>
                            <li><span class="syntax-code">// æ³¨é‡Šå†…å®¹</span> - æ·»åŠ è§„åˆ™æ³¨é‡Šï¼ˆå»ºè®®æ”¾åœ¨è§„åˆ™åä¸‹ä¸€è¡Œï¼Œæœ€å¤š60å­—ç¬¦ï¼‰</li>
                            <li><span class="syntax-code">é›†åˆå=={å…ƒç´ 1,å…ƒç´ 2,...}</span> - å®šä¹‰å±€éƒ¨é›†åˆï¼ˆä»…åœ¨å½“å‰è§„åˆ™å†…æœ‰æ•ˆï¼‰</li>
                            <li><span class="syntax-code">(é›†åˆå)</span> - å¼•ç”¨é›†åˆï¼ˆå•å­—æ¯é›†åˆå¿…é¡»å¤§å†™ï¼Œå¤šå­—æ¯é›†åˆå¤§å°å†™æ•æ„Ÿä¸”å¿…é¡»ç”¨æ‹¬å·ï¼‰</li>
                            <li><span class="syntax-code">!å…·ä½“è§„åˆ™</span> - å®šä¹‰åŒ¹é…æ¨¡å¼</li>
                            <li><span class="syntax-code">@æ˜¾ç¤ºè§„åˆ™</span> - å®šä¹‰æ’åºæ–¹å¼ï¼ˆå¯é€‰ï¼‰</li>
                            <li><span class="syntax-code">\b</span> - å•è¯å¼€å¤´ï¼Œ<span class="syntax-code">\e</span> -
                                å•è¯ç»“å°¾ï¼Œ<span class="syntax-code">\m</span> - å•è¯ä¸­é—´</li>
                        </ul>
                    </div>

                    <!-- å…¨å±€é›†åˆç¼–è¾‘åŒº -->
                    <div class="global-sets-editor">
                        <h4>å…¨å±€é›†åˆå®šä¹‰</h4>
                        <textarea id="globalSetsEditor" class="global-sets-textarea"
                            placeholder="åœ¨æ­¤å®šä¹‰å…¨å±€é›†åˆï¼Œæ¯è¡Œä¸€ä¸ªé›†åˆå®šä¹‰ï¼Œæ ¼å¼ï¼šé›†åˆå=={å…ƒç´ 1,å…ƒç´ 2,...}\nä¾‹å¦‚ï¼š\nC=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}\nV=={a,e,i,o,u}">C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}\nV=={a,e,i,o,u}\nL=={a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}</textarea>
                        <button id="updateGlobalSetsBtn" class="btn btn-secondary">æ›´æ–°å…¨å±€é›†åˆ</button>
                    </div>





                    <textarea id="ruleEditor" class="rule-textarea" placeholder="åœ¨æ­¤è¾“å…¥è§„åˆ™å®šä¹‰...
æ ¼å¼ç¤ºä¾‹ï¼š
#è§„åˆ™å
// è§„åˆ™æ³¨é‡Šï¼ˆå¯é€‰ï¼Œæœ€å¤š60å­—ç¬¦ï¼‰
é›†åˆå=={å…ƒç´ 1,å…ƒç´ 2,...}
!å…·ä½“è§„åˆ™
@æ˜¾ç¤ºè§„åˆ™

æ³¨æ„ï¼š
- é›†åˆå®šä¹‰ä»…åœ¨å½“å‰è§„åˆ™å†…æœ‰æ•ˆ
- ä½¿ç”¨(é›†åˆå)å¼•ç”¨å…¨å±€é›†åˆ
- ä¸å…è®¸ä½¿ç”¨å¤§å†™å­—æ¯ç»„åˆç›´æ¥å®šä¹‰é›†åˆ"></textarea>

                    <div class="rule-actions">
                        <button id="saveRuleBtn" class="btn btn-primary">ä¿å­˜è§„åˆ™</button>
                        <button id="testRuleBtn" class="btn btn-secondary">æµ‹è¯•è§„åˆ™</button>
                        <button id="clearRuleBtn" class="btn btn-outline">æ¸…ç©ºç¼–è¾‘å™¨</button>
                        <button id="formatRuleBtn" class="btn btn-outline">æ ¼å¼åŒ–</button>

                    </div>
                </div>
            </div>

            <!-- ä¸‹åŠåŒºï¼šå·²ä¿å­˜çš„è§„åˆ™ -->
            <div class="saved-rules-section">
                <div class="saved-rules-header">
                    <h2>å·²ä¿å­˜çš„è§„åˆ™</h2>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button id="exportRulesBtn" class="btn btn-secondary">å¯¼å‡ºè§„åˆ™</button>
                        <button id="importRulesBtn" class="btn btn-secondary">å¯¼å…¥è§„åˆ™</button>
                        <button id="clearAllRulesBtn" class="btn btn-danger" onclick="ruleManager.clearAllRules()">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è§„åˆ™
                        </button>
                    </div>
                </div>
                <div id="savedRulesContainer" class="saved-rules-container"></div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="messageContainer" class="message-container"></div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <p>æ­£åœ¨å¤„ç†...</p>
    </div>

    <!-- è¯¦ç»†å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="detailedHelpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è§„åˆ™è¯­æ³•è¯¦ç»†å¸®åŠ©</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="help-content">
                    <h4>åŸºæœ¬è¯­æ³•</h4>
                    <ul>
                        <li><strong>#è§„åˆ™å</strong> - å®šä¹‰è§„åˆ™åç§°</li>
                        <li><strong>// æ³¨é‡Šå†…å®¹</strong> - æ·»åŠ è§„åˆ™æ³¨é‡Šï¼ˆå¯é€‰ï¼Œæœ€å¤š60å­—ç¬¦ï¼‰</li>
                        <li><strong>é›†åˆå®šä¹‰</strong> - C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}</li>
                        <li><strong>!å…·ä½“è§„åˆ™</strong> - å®šä¹‰åŒ¹é…æ¨¡å¼</li>
                        <li><strong>@æ˜¾ç¤ºè§„åˆ™</strong> - å®šä¹‰æ’åºæ–¹å¼</li>
                    </ul>
                    <h4>ä½ç½®æ ‡å¿—</h4>
                    <ul>
                        <li><strong>\b</strong> - å•è¯å¼€å¤´</li>
                        <li><strong>\e</strong> - å•è¯ç»“å°¾</li>
                        <li><strong>\m</strong> - å•è¯ä¸­é—´</li>
                        <li><strong>\-b</strong> - ä¸åœ¨å¼€å¤´</li>
                        <li><strong>\-e</strong> - ä¸åœ¨ç»“å°¾</li>
                    </ul>
                    <h4>ç¤ºä¾‹è§„åˆ™</h4>
                    <pre>C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}
V=={a,e,i,o,u}

#CVC
!\bCVC\e
@

#CVCE
!\bCVC[e]\e
@</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- å¼•å…¥è‡ªå®šä¹‰è„šæœ¬ -->
    <script src="js/fileUtils.js"></script>
    <script src="js/fileStorage.js"></script>
    <script src="js/ruleEngine.js"></script>
    <script src="js/version.js"></script>
    <script>
        // è§„åˆ™ç®¡ç†é¡µé¢ä¸“ç”¨è„šæœ¬
        class RuleManagerApp {
            constructor() {
                this.ruleEngine = new RuleEngine();
                this.initializeApp();
            }

            initializeApp() {
                this.bindEvents();
                this.ruleEngine.loadSavedRules();
                this.loadSavedRules();
                this.initializeGlobalSetsEditor();
            }

            // åˆå§‹åŒ–å…¨å±€é›†åˆç¼–è¾‘å™¨
            initializeGlobalSetsEditor() {
                const globalSetsEditor = document.getElementById('globalSetsEditor');
                const savedGlobalSets = JSON.parse(localStorage.getItem('globalSets') || '{}');

                let defaultSets = `C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}
V=={a,e,i,o,u}
L=={a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}`;

                // æ·»åŠ ä¿å­˜çš„è‡ªå®šä¹‰é›†åˆ
                for (const [setName, setValues] of Object.entries(savedGlobalSets)) {
                    if (!['C', 'V', 'L'].includes(setName)) {
                        defaultSets += `
${setName}=={${setValues.join(',')}}`;
                    }
                }

                globalSetsEditor.value = defaultSets;
            }

            bindEvents() {
                // å¯¼å‡ºè§„åˆ™æŒ‰é’®
                document.getElementById('exportRulesBtn').addEventListener('click', async () => {
                    await this.exportRules();
                });

                // å¯¼å…¥è§„åˆ™æŒ‰é’®
                document.getElementById('importRulesBtn').addEventListener('click', () => {
                    this.importRules();
                });

                // è¿”å›ä¸»é¡µ
                document.getElementById('backToMainBtn').addEventListener('click', () => {
                    window.location.href = 'index.html';
                });

                // ä¿å­˜è§„åˆ™
                document.getElementById('saveRuleBtn').addEventListener('click', () => {
                    this.saveRule();
                });

                // æµ‹è¯•è§„åˆ™
                document.getElementById('testRuleBtn').addEventListener('click', () => {
                    this.testRule();
                });

                // æ¸…ç©ºç¼–è¾‘å™¨
                document.getElementById('clearRuleBtn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹å—ï¼Ÿ')) {
                        document.getElementById('ruleEditor').value = '';
                    }
                });

                // æ ¼å¼åŒ–è§„åˆ™
                document.getElementById('formatRuleBtn').addEventListener('click', () => {
                    this.formatRule();
                });

                // è§„åˆ™ç¼–è¾‘å™¨ç²˜è´´äº‹ä»¶ - è‡ªåŠ¨æ ¼å¼åŒ–
                document.getElementById('ruleEditor').addEventListener('paste', (event) => {
                    // å»¶è¿Ÿæ‰§è¡Œæ ¼å¼åŒ–ï¼Œç¡®ä¿ç²˜è´´å†…å®¹å·²ç»æ’å…¥
                    setTimeout(() => {
                        this.formatRule();
                    }, 10);
                });

                // æ›´æ–°å…¨å±€é›†åˆ
                document.getElementById('updateGlobalSetsBtn').addEventListener('click', () => {
                    this.updateGlobalSets();
                });

                // è¯¦ç»†å¸®åŠ©æŒ‰é’®
                document.getElementById('detailedHelpBtn').addEventListener('click', () => {
                    this.showDetailedHelp();
                });

                // è¯¦ç»†å¸®åŠ©æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
                const detailedHelpModal = document.getElementById('detailedHelpModal');
                const closeBtn = detailedHelpModal.querySelector('.close');

                closeBtn.addEventListener('click', () => {
                    detailedHelpModal.style.display = 'none';
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                window.addEventListener('click', (event) => {
                    if (event.target === detailedHelpModal) {
                        detailedHelpModal.style.display = 'none';
                    }
                });
            }

            saveRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();

                if (!ruleText) {
                    this.showMessage('è¯·è¾“å…¥è§„åˆ™å†…å®¹', 'warning');
                    return;
                }

                // æ£€æŸ¥è§„åˆ™åç§°æ˜¯å¦ä»¥#å¼€å¤´
                const lines = ruleText.split('\n');
                const nameMatch = lines[0].match(/^#(.+)$/);
                if (!nameMatch) {
                    this.showMessage('è§„åˆ™åç§°å¿…é¡»ä»¥#å¼€å¤´', 'error');
                    return;
                }

                try {
                    // ç›´æ¥è§£æè§„åˆ™æ–‡æœ¬ï¼ˆæ³¨é‡Šå·²åŒ…å«åœ¨æ–‡æœ¬ä¸­ï¼‰
                    const rule = this.ruleEngine.parseRule(ruleText);

                    // æ£€æŸ¥è§„åˆ™å†²çª
                    const conflicts = this.checkRuleConflicts(rule);
                    if (conflicts.length > 0) {
                        const conflictMsg = `æ£€æµ‹åˆ°è§„åˆ™å†²çª:\n${conflicts.join('\n')}`;
                        if (!confirm(`${conflictMsg}\n\næ˜¯å¦ä»è¦ä¿å­˜æ­¤è§„åˆ™ï¼Ÿ`)) {
                            return;
                        }
                    }

                    this.ruleEngine.saveRule(rule);
                    this.loadSavedRules();
                    document.getElementById('ruleEditor').value = '';

                    this.showMessage(`è§„åˆ™ "${rule.name}" ä¿å­˜æˆåŠŸ`, 'success');

                } catch (error) {
                    console.error('è§„åˆ™ä¿å­˜é”™è¯¯:', error);
                    this.showMessage(`è§„åˆ™ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                }
            }

            testRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();

                if (!ruleText) {
                    this.showMessage('è¯·è¾“å…¥è§„åˆ™å†…å®¹', 'warning');
                    return;
                }

                try {
                    const rule = this.ruleEngine.parseRule(ruleText);

                    const testWords = ['apple', 'banana', 'cat', 'dog', 'elephant', 'fish', 'grape', 'house'];
                    const testResults = [];

                    for (const word of testWords) {
                        const matches = this.ruleEngine.matchesRule(word, rule);
                        testResults.push(`${word}: ${matches ? 'âœ“' : 'âœ—'}`);
                    }

                    const resultText = `æµ‹è¯•ç»“æœ:\n${testResults.join('\n')}`;
                    alert(resultText);

                } catch (error) {
                    console.error('è§„åˆ™æµ‹è¯•é”™è¯¯:', error);
                    this.showMessage(`è§„åˆ™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            formatRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();
                if (!ruleText) return;

                // æ ¼å¼åŒ–è§„åˆ™ï¼šä¸æ·»åŠ ç©ºè¡Œï¼Œä¿æŒç´§å‡‘æ ¼å¼
                const lines = ruleText.split('\n');
                const formattedLines = [];

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed) { // åªä¿ç•™éç©ºè¡Œ
                        formattedLines.push(trimmed);
                    }
                }

                document.getElementById('ruleEditor').value = formattedLines.join('\n');
            }

            // æ’å…¥éæ“ä½œç¬¦


            loadSavedRules() {
                const container = document.getElementById('savedRulesContainer');
                const ruleNames = this.ruleEngine.getRuleNames();

                if (ruleNames.length === 0) {
                    container.className = 'saved-rules-container empty';
                    container.innerHTML = '<div style="color: #a0aec0; font-size: 16px; font-weight: 500;">æš‚æ— ä¿å­˜çš„è§„åˆ™</div>';
                    return;
                }

                container.className = 'saved-rules-container';

                // è·å–ä¿å­˜çš„æ’åº
                const savedOrder = this.loadRuleOrder();

                // æŒ‰ä¿å­˜çš„é¡ºåºæ’åºï¼Œæœªæ’åºçš„è§„åˆ™æ”¾åœ¨æœ€å
                const orderedRules = [];
                savedOrder.forEach(name => {
                    if (ruleNames.includes(name)) {
                        orderedRules.push(name);
                    }
                });
                ruleNames.forEach(name => {
                    if (!orderedRules.includes(name)) {
                        orderedRules.push(name);
                    }
                });

                // æŒ‰åç§°åˆ†ç»„ï¼Œåˆ›å»ºæ ‘å½¢ç»“æ„
                const ruleGroups = this.groupRulesByName(orderedRules);
                let html = '<div class="rule-tree">';

                for (const [groupName, rules] of Object.entries(ruleGroups)) {
                    if (rules.length === 1) {
                        // å•ä¸ªè§„åˆ™
                        const rule = this.ruleEngine.getRule(rules[0]);
                        html += this.createRuleItemHTML(rules[0], rule, false);
                    } else {
                        // è§„åˆ™ç»„ï¼ˆé»˜è®¤æ”¶ç¼©ï¼‰
                        html += `
                            <div class="rule-group collapsed">
                                <div class="rule-group-header" onclick="this.parentNode.classList.toggle('collapsed')">
                                    <span class="rule-group-toggle">â–¶</span>
                                    <span class="rule-group-title">${groupName}</span>
                                    <span class="group-count">(${rules.length})</span>
                                </div>
                                <div class="rule-group-content">
                        `;

                        rules.forEach(ruleName => {
                            const rule = this.ruleEngine.getRule(ruleName);
                            html += this.createRuleItemHTML(ruleName, rule, true);
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    }
                }

                html += '</div>';
                container.innerHTML = html;

                // æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½
                this.initializeDragAndDrop(container);
            }

            editRule(ruleName) {
                const rule = this.ruleEngine.getRule(ruleName);
                if (!rule) return;

                let ruleText = `#${rule.name}`;

                if (rule.localSets.size > 0) {
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.from(setValues).join(',');
                        ruleText += `\n${setName}=={${values}}`;
                    }
                }

                ruleText += `\n${rule.specificRule}`;

                if (rule.displayRule) {
                    ruleText += `\n${rule.displayRule}`;
                }

                // å¦‚æœæœ‰æ³¨é‡Šï¼Œå°†æ³¨é‡Šæ·»åŠ åˆ°è§„åˆ™æ–‡æœ¬ä¸­
                if (rule.comment) {
                    const lines = ruleText.split('\n');
                    // åœ¨è§„åˆ™åç§°åæ’å…¥æ³¨é‡Šè¡Œ
                    lines.splice(1, 0, `// ${rule.comment}`);
                    ruleText = lines.join('\n');
                }

                // å¡«å…¥å®Œæ•´çš„è§„åˆ™æ–‡æœ¬ï¼ˆåŒ…å«æ³¨é‡Šï¼‰
                document.getElementById('ruleEditor').value = ruleText;
                document.getElementById('ruleEditor').focus();
            }

            deleteRule(ruleName) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™ "${ruleName}" å—ï¼Ÿ`)) {
                    this.ruleEngine.deleteRule(ruleName);
                    this.loadSavedRules();
                    this.showMessage(`è§„åˆ™ "${ruleName}" å·²åˆ é™¤`, 'success');
                }
            }

            showMessage(message, type = 'info') {
                const messageContainer = document.getElementById('messageContainer');

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;

                messageContainer.appendChild(messageDiv);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }

            // æŒ‰åç§°åˆ†ç»„è§„åˆ™
            groupRulesByName(ruleNames) {
                const groups = {};

                ruleNames.forEach(name => {
                    // æå–åŸºç¡€åç§°ï¼ˆå»æ‰æ•°å­—åç¼€ç­‰ï¼‰
                    const baseName = name.replace(/\d+$/, '').replace(/[_-]\d+$/, '');

                    if (!groups[baseName]) {
                        groups[baseName] = [];
                    }
                    groups[baseName].push(name);
                });

                return groups;
            }

            // åˆ›å»ºè§„åˆ™é¡¹HTML
            createRuleItemHTML(ruleName, rule, isInGroup) {
                const ruleText = this.formatRuleText(rule);
                const commentText = rule.comment ? rule.comment : '';

                return `
                    <div class="rule-item-header" draggable="true" data-rule-name="${ruleName}" onclick="ruleManager.toggleRuleExpansion('${ruleName}')">
                        <div class="rule-item-main">
                            <span class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</span>
                            <span class="rule-item-expand-icon">â–¶</span>
                            <span class="rule-item-name">${ruleName}</span>
                            ${commentText ? `<span class="rule-item-comment">// ${commentText}</span>` : ''}
                        </div>
                        <div class="rule-item-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-small btn-outline" onclick="ruleManager.editRule('${ruleName}')" title="ç¼–è¾‘è§„åˆ™">ç¼–è¾‘</button>
                            <button class="btn btn-small btn-secondary" onclick="ruleManager.deleteRule('${ruleName}')" title="åˆ é™¤è§„åˆ™">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="rule-item-content">${ruleText}</div>
                `;
            }

            // é‡æ„è§„åˆ™æ–‡æœ¬
            reconstructRuleText(rule) {
                let parts = [`#${rule.name}`];

                // æ·»åŠ å±€éƒ¨é›†åˆå®šä¹‰
                if (rule.localSets && rule.localSets.size > 0) {
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.isArray(setValues) ? setValues : Array.from(setValues);
                        parts.push(`${setName}=={${values.join(',')}}`);
                    }
                }

                // æ·»åŠ å…·ä½“è§„åˆ™
                if (rule.specificRule) {
                    parts.push(rule.specificRule);
                }

                // æ·»åŠ æ˜¾ç¤ºè§„åˆ™
                if (rule.displayRule) {
                    parts.push(rule.displayRule);
                } else {
                    parts.push('@');
                }

                return parts.join(' | ');
            }

            // æ ¼å¼åŒ–è§„åˆ™æ–‡æœ¬ç”¨äºå±•ç¤º
            formatRuleText(rule) {
                let lines = [];

                // è§„åˆ™åç§°
                lines.push(`# ${rule.name}`);

                // æ³¨é‡Š
                if (rule.comment) {
                    lines.push(`// ${rule.comment}`);
                }

                // å±€éƒ¨é›†åˆå®šä¹‰
                if (rule.localSets && rule.localSets.size > 0) {
                    lines.push('');
                    lines.push('# å±€éƒ¨é›†åˆå®šä¹‰:');
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.isArray(setValues) ? setValues : Array.from(setValues);
                        lines.push(`${setName} == {${values.join(', ')}}`);
                    }
                }

                // å…·ä½“è§„åˆ™
                if (rule.specificRule) {
                    lines.push('');
                    lines.push('# å…·ä½“è§„åˆ™:');
                    lines.push(rule.specificRule);
                }

                // æ˜¾ç¤ºè§„åˆ™
                lines.push('');
                lines.push('# æ˜¾ç¤ºè§„åˆ™:');
                lines.push(rule.displayRule || '@');

                return lines.join('\n');
            }

            // åˆ‡æ¢è§„åˆ™å±•å¼€çŠ¶æ€
            toggleRuleExpansion(ruleName) {
                const ruleHeader = document.querySelector(`[data-rule-name="${ruleName}"]`);
                if (ruleHeader) {
                    ruleHeader.classList.toggle('expanded');
                    const expandIcon = ruleHeader.querySelector('.rule-item-expand-icon');
                    if (expandIcon) {
                        expandIcon.textContent = ruleHeader.classList.contains('expanded') ? 'â–¼' : 'â–¶';
                    }
                    // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
                    const content = ruleHeader.nextElementSibling;
                    if (content && content.classList.contains('rule-item-content')) {
                        content.style.display = ruleHeader.classList.contains('expanded') ? 'block' : 'none';
                    }
                }
            }

            // ä¿å­˜è§„åˆ™æ’åºåˆ°æœ¬åœ°å­˜å‚¨
            saveRuleOrder() {
                const container = document.getElementById('savedRulesContainer');
                const ruleHeaders = container.querySelectorAll('.rule-item-header');
                const ruleOrder = Array.from(ruleHeaders).map(item => item.dataset.ruleName);
                localStorage.setItem('ruleOrder', JSON.stringify(ruleOrder));
            }

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§„åˆ™æ’åº
            loadRuleOrder() {
                const savedOrder = localStorage.getItem('ruleOrder');
                if (savedOrder) {
                    try {
                        return JSON.parse(savedOrder);
                    } catch (e) {
                        console.warn('Failed to parse saved rule order:', e);
                    }
                }
                return [];
            }

            // åº”ç”¨è§„åˆ™æ’åº
            applyRuleOrder(rules) {
                const savedOrder = this.loadRuleOrder();
                if (savedOrder.length === 0) {
                    return rules;
                }

                const orderedRules = {};
                const unorderedRules = {};

                // åˆ†ç¦»å·²æ’åºå’Œæœªæ’åºçš„è§„åˆ™
                for (const [name, rule] of Object.entries(rules)) {
                    if (savedOrder.includes(name)) {
                        orderedRules[name] = rule;
                    } else {
                        unorderedRules[name] = rule;
                    }
                }

                // æŒ‰ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—
                const result = {};
                for (const name of savedOrder) {
                    if (orderedRules[name]) {
                        result[name] = orderedRules[name];
                    }
                }

                // æ·»åŠ æ–°çš„æœªæ’åºè§„åˆ™åˆ°æœ«å°¾
                for (const [name, rule] of Object.entries(unorderedRules)) {
                    result[name] = rule;
                }

                return result;
            }

            // æ›´æ–°å…¨å±€é›†åˆ
            updateGlobalSets() {
                const globalSetsText = document.getElementById('globalSetsEditor').value.trim();

                if (!globalSetsText) {
                    this.showMessage('è¯·è¾“å…¥å…¨å±€é›†åˆå®šä¹‰', 'warning');
                    return;
                }

                try {
                    // è§£æå…¨å±€é›†åˆå®šä¹‰
                    const lines = globalSetsText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    const newGlobalSets = new Map();

                    for (const line of lines) {
                        if (line.includes('==')) {
                            const [setName, setDef] = line.split('==');
                            const cleanSetName = setName.trim();

                            // éªŒè¯é›†åˆåç§°
                            if (cleanSetName.length === 1) {
                                // å•å­—æ¯é›†åˆåå¿…é¡»æ˜¯å¤§å†™
                                if (!/^[A-Z]$/.test(cleanSetName)) {
                                    throw new Error(`å•å­—æ¯é›†åˆå "${cleanSetName}" å¿…é¡»æ˜¯å¤§å†™å­—æ¯`);
                                }
                            } else {
                                // å¤šå­—æ¯é›†åˆååœ¨å¼•ç”¨æ—¶éœ€è¦ç”¨æ‹¬å·
                                console.warn(`é›†åˆåç§° "${cleanSetName}" é•¿åº¦è¶…è¿‡1ä¸ªå­—ç¬¦ï¼Œåœ¨å¼•ç”¨æ—¶è¯·ä½¿ç”¨æ‹¬å·ï¼š(${cleanSetName})`);
                            }

                            const setValues = this.parseSetValues(setDef.trim());
                            newGlobalSets.set(cleanSetName, setValues);
                        }
                    }

                    // æ›´æ–°RuleEngineä¸­çš„å…¨å±€é›†åˆ
                    this.ruleEngine.updateGlobalSets(newGlobalSets);

                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const globalSetsData = {};
                    for (const [setName, setValues] of newGlobalSets) {
                        globalSetsData[setName] = Array.from(setValues);
                    }
                    localStorage.setItem('globalSets', JSON.stringify(globalSetsData));

                    this.showMessage('å…¨å±€é›†åˆæ›´æ–°æˆåŠŸ', 'success');

                } catch (error) {
                    console.error('å…¨å±€é›†åˆæ›´æ–°é”™è¯¯:', error);
                    this.showMessage(`å…¨å±€é›†åˆæ›´æ–°å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // è§£æé›†åˆå€¼
            parseSetValues(setDef) {
                if (setDef.startsWith('{') && setDef.endsWith('}')) {
                    const content = setDef.slice(1, -1);
                    return new Set(content.split(',').map(item => item.trim()).filter(item => item.length > 0));
                }
                throw new Error(`é›†åˆå®šä¹‰æ ¼å¼é”™è¯¯: ${setDef}`);
            }

            // åˆå§‹åŒ–æ‹–æ‹½æ’åº
            initializeDragAndDrop(container) {
                let draggedElement = null;

                container.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('rule-item')) {
                        draggedElement = e.target;
                        e.target.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', e.target.outerHTML);
                    }
                });

                container.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('rule-item')) {
                        e.target.classList.remove('dragging');
                        // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æŒ‡ç¤ºå™¨
                        container.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        draggedElement = null;
                    }
                });

                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    const draggables = [...container.querySelectorAll('.rule-item-header:not(.dragging)')];

                    // æ¸…é™¤ä¹‹å‰çš„æŒ‡ç¤ºå™¨
                    draggables.forEach(el => el.classList.remove('drag-over'));

                    // æ·»åŠ æ–°çš„æŒ‡ç¤ºå™¨
                    if (afterElement) {
                        afterElement.classList.add('drag-over');
                    }
                });

                container.addEventListener('drop', (e) => {
                    e.preventDefault();

                    if (draggedElement) {
                        const afterElement = this.getDragAfterElement(container, e.clientY);

                        if (afterElement == null) {
                            container.appendChild(draggedElement);
                        } else {
                            container.insertBefore(draggedElement, afterElement);
                        }

                        // ä¿å­˜æ–°çš„æ’åºåˆ°æœ¬åœ°å­˜å‚¨
                        this.saveRuleOrder();
                        this.showMessage('è§„åˆ™æ’åºå·²æ›´æ–°', 'success');
                    }

                    // æ¸…é™¤æ‹–æ‹½æŒ‡ç¤ºå™¨
                    container.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                });

                container.addEventListener('dragleave', (e) => {
                    // å½“æ‹–æ‹½ç¦»å¼€å®¹å™¨æ—¶æ¸…é™¤æŒ‡ç¤ºå™¨
                    if (!container.contains(e.relatedTarget)) {
                        container.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                    }
                });
            }

            // è·å–æ‹–æ‹½åçš„ä½ç½®
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.rule-item-header:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // ä¿å­˜è§„åˆ™æ’åº
            saveRuleOrder() {
                const ruleHeaders = [...document.querySelectorAll('.rule-item-header[data-rule-name]')];
                const order = ruleHeaders.map(item => item.getAttribute('data-rule-name'));
                localStorage.setItem('ruleOrder', JSON.stringify(order));
            }

            // åŠ è½½è§„åˆ™æ’åº
            loadRuleOrder() {
                const savedOrder = localStorage.getItem('ruleOrder');
                return savedOrder ? JSON.parse(savedOrder) : [];
            }

            // æ£€æŸ¥è§„åˆ™å†²çª
            checkRuleConflicts(newRule) {
                const conflicts = [];
                const existingRules = this.ruleEngine.getRuleNames();

                // æ£€æŸ¥åç§°å†²çª
                if (existingRules.includes(newRule.name)) {
                    conflicts.push(`è§„åˆ™åç§° "${newRule.name}" å·²å­˜åœ¨`);
                }

                // æ£€æŸ¥é›†åˆå®šä¹‰å†²çª
                for (const [setName, setValues] of newRule.localSets) {
                    for (const existingRuleName of existingRules) {
                        const existingRule = this.ruleEngine.getRule(existingRuleName);
                        if (existingRule.localSets.has(setName)) {
                            const existingValues = existingRule.localSets.get(setName);
                            const newValues = Array.from(setValues).sort();
                            const oldValues = Array.from(existingValues).sort();

                            if (JSON.stringify(newValues) !== JSON.stringify(oldValues)) {
                                conflicts.push(`é›†åˆ "${setName}" åœ¨è§„åˆ™ "${existingRuleName}" ä¸­æœ‰ä¸åŒå®šä¹‰`);
                            }
                        }
                    }
                }

                return conflicts;
            }

            // æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è§„åˆ™
            clearAllRules() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è§„åˆ™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    // æ¸…é™¤RuleEngineä¸­çš„æ‰€æœ‰è§„åˆ™
                    const ruleNames = this.ruleEngine.getRuleNames();
                    ruleNames.forEach(ruleName => {
                        this.ruleEngine.deleteRule(ruleName);
                    });

                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„è§„åˆ™æ•°æ®
                    localStorage.removeItem('wordFilterRules');
                    localStorage.removeItem('ruleOrder');

                    // åˆ·æ–°æ˜¾ç¤º
                    this.loadSavedRules();

                    this.showMessage('æ‰€æœ‰è§„åˆ™å·²æ¸…é™¤', 'success');
                }
            }

            // æ˜¾ç¤ºè¯¦ç»†å¸®åŠ©
            showDetailedHelp() {
                const detailedHelpModal = document.getElementById('detailedHelpModal');
                detailedHelpModal.style.display = 'flex';
            }

            // è·å–æ‰€æœ‰å…¨å±€é›†åˆ
            getAllGlobalSets() {
                // ç›´æ¥ä»RuleEngineè·å–çœŸæ­£çš„å…¨å±€é›†åˆ
                return this.ruleEngine.getGlobalSets();
            }

            /**
             * å¯¼å‡ºè§„åˆ™åˆ°æ–‡ä»¶
             */
            async exportRules() {
                try {
                    const success = await this.ruleEngine.exportRulesToFile();
                    if (success) {
                        this.showMessage('è§„åˆ™å¯¼å‡ºæˆåŠŸï¼', 'success');
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œä¸æ˜¾ç¤ºä»»ä½•æ¶ˆæ¯
                        return;
                    }
                    console.error('å¯¼å‡ºè§„åˆ™å¤±è´¥:', error);
                    this.showMessage('å¯¼å‡ºè§„åˆ™å¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * ä»æ–‡ä»¶å¯¼å…¥è§„åˆ™
             */
            importRules() {
                try {
                    this.ruleEngine.importRulesFromFile();

                    // ç›‘å¬è§„åˆ™æ›´æ–°äº‹ä»¶
                    window.addEventListener('rulesUpdated', () => {
                        this.loadSavedRules();
                        this.showMessage('è§„åˆ™å¯¼å…¥æˆåŠŸï¼', 'success');
                    }, { once: true });
                } catch (error) {
                    console.error('å¯¼å…¥è§„åˆ™å¤±è´¥:', error);
                    this.showMessage('å¯¼å…¥è§„åˆ™å¤±è´¥: ' + error.message, 'error');
                }
            }
        } // RuleManagerApp ç±»ç»“æŸ

        // åˆå§‹åŒ–åº”ç”¨
        let ruleManager;
        let isNarrowScreen = false;

        document.addEventListener('DOMContentLoaded', () => {
            ruleManager = new RuleManagerApp();
            // æ¢å¤ç¤ºä¾‹çš„å±•å¼€/æ”¶ç¼©çŠ¶æ€
            restoreExampleStates();

            // åˆå§‹åŒ–å“åº”å¼ç›‘å¬
            handleResponsiveExamples();
            window.addEventListener('resize', handleResponsiveExamples);
        });

        // å¤„ç†å“åº”å¼ç¤ºä¾‹æ”¶ç¼©
        function handleResponsiveExamples() {
            const currentIsNarrow = window.innerWidth <= 768;

            // åªåœ¨ä»å®½å±åˆ‡æ¢åˆ°çª„å±æ—¶è‡ªåŠ¨æ”¶ç¼©
            if (!isNarrowScreen && currentIsNarrow) {
                collapseAllExamples();
            }

            isNarrowScreen = currentIsNarrow;
        }

        // æ”¶ç¼©æ‰€æœ‰ç¤ºä¾‹ï¼ˆä¸ä¿å­˜çŠ¶æ€ï¼‰
        function collapseAllExamples() {
            const exampleSections = document.querySelectorAll('.example-section');

            exampleSections.forEach(section => {
                section.classList.add('collapsed');
            });

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // å…¨å±€æ”¶ç¼©/å±•å¼€å‡½æ•°
        function toggleExample(titleElement) {
            const exampleSection = titleElement.parentElement;
            exampleSection.classList.toggle('collapsed');

            // ä¿å­˜å±•å¼€/æ”¶ç¼©çŠ¶æ€åˆ°localStorage
            const titleText = titleElement.textContent.trim();
            const isCollapsed = exampleSection.classList.contains('collapsed');
            const exampleStates = JSON.parse(localStorage.getItem('exampleStates') || '{}');
            exampleStates[titleText] = isCollapsed;
            localStorage.setItem('exampleStates', JSON.stringify(exampleStates));

            // æ›´æ–°æ”¶ç¼©/å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ¢å¤ç¤ºä¾‹çš„å±•å¼€/æ”¶ç¼©çŠ¶æ€
        function restoreExampleStates() {
            const exampleStates = JSON.parse(localStorage.getItem('exampleStates') || '{}');
            const exampleSections = document.querySelectorAll('.example-section');

            exampleSections.forEach(section => {
                const titleElement = section.querySelector('.example-title');
                const titleText = titleElement.textContent.trim();

                if (exampleStates[titleText]) {
                    section.classList.add('collapsed');
                }
            });

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ”¶ç¼©/å±•å¼€å…¨éƒ¨ç¤ºä¾‹
        function toggleAllExamples() {
            const exampleSections = document.querySelectorAll('.example-section');
            const toggleBtn = document.querySelector('.toggle-all-btn .toggle-all-text');

            // æ£€æŸ¥å½“å‰çŠ¶æ€ï¼šå¦‚æœæ‰€æœ‰ç¤ºä¾‹éƒ½æ˜¯æ”¶ç¼©çš„ï¼Œåˆ™å±•å¼€å…¨éƒ¨ï¼›å¦åˆ™æ”¶ç¼©å…¨éƒ¨
            const allCollapsed = Array.from(exampleSections).every(section =>
                section.classList.contains('collapsed')
            );

            const exampleStates = {};

            exampleSections.forEach(section => {
                const titleElement = section.querySelector('.example-title');
                const titleText = titleElement.textContent.trim();

                if (allCollapsed) {
                    // å±•å¼€å…¨éƒ¨
                    section.classList.remove('collapsed');
                    exampleStates[titleText] = false;
                } else {
                    // æ”¶ç¼©å…¨éƒ¨
                    section.classList.add('collapsed');
                    exampleStates[titleText] = true;
                }
            });

            // ä¿å­˜çŠ¶æ€
            localStorage.setItem('exampleStates', JSON.stringify(exampleStates));

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ›´æ–°æ”¶ç¼©/å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
        function updateToggleAllButtonText() {
            const exampleSections = document.querySelectorAll('.example-section');
            const toggleBtn = document.querySelector('.toggle-all-btn .toggle-all-text');

            if (!toggleBtn) return;

            const allCollapsed = Array.from(exampleSections).every(section =>
                section.classList.contains('collapsed')
            );

            toggleBtn.textContent = allCollapsed ? 'å±•å¼€å…¨éƒ¨' : 'æ”¶ç¼©å…¨éƒ¨';
        }

        // å…¨å±€å¤åˆ¶å‡½æ•°
        function copyExample(button) {
            const codeBlock = button.parentElement;

            // å…‹éš†ä»£ç å—ä»¥é¿å…ä¿®æ”¹åŸå§‹å†…å®¹
            const clonedBlock = codeBlock.cloneNode(true);

            // ä»å…‹éš†çš„å—ä¸­ç§»é™¤å¤åˆ¶æŒ‰é’®
            const clonedButton = clonedBlock.querySelector('button');
            if (clonedButton) {
                clonedButton.remove();
            }

            // è·å–çº¯æ–‡æœ¬å†…å®¹
            const textToCopy = clonedBlock.textContent.trim();

            if (!textToCopy) {
                button.textContent = 'æ— å†…å®¹';
                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶';
                }, 2000);
                return;
            }

            // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    button.textContent = 'å·²å¤åˆ¶';
                    setTimeout(() => {
                        button.textContent = 'å¤åˆ¶';
                    }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(textToCopy, button);
                });
            } else {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopy(textToCopy, button);
            }
        }

        function fallbackCopy(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                button.textContent = 'å·²å¤åˆ¶';
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.textContent = 'å¤åˆ¶å¤±è´¥';
            }

            document.body.removeChild(textArea);
            setTimeout(() => {
                button.textContent = 'å¤åˆ¶';
            }, 2000);
        }
    </script>
</body>

</html>