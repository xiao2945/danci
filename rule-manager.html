<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§„åˆ™ç®¡ç† - å•è¯ç­›é€‰å·¥å…·</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .rule-manager-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .rule-manager-container {
                padding: 10px !important;
                /* max-width: 100% !important; */
            }
        }

        .rule-manager-header,
        .rule-manager-header {
            text-align: left !important;
        }

        .rule-manager-header h1 {
            text-align: left !important;
        }

        .rule-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            /* gap: 15px; */
            /* å¼ºåˆ¶å·¦å¯¹é½ï¼Œè¦†ç›–å…¨å±€header */
        }

        .rule-manager-header h1 {
            font-size: 1.5rem;
            margin: 0;
            margin-right: 15px;
        }

        .rule-manager-header p {
            font-size: 0.9rem;
            margin: 0;
            color: white;
        }

        .rule-manager-header>div:first-child {
            display: flex;
            align-items: baseline;
            gap: 15px;
            justify-content: flex-start;
            flex: 0 1 auto;
            min-width: 0;
        }

        .rule-manager-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 60vh;
        }

        @media (max-width: 768px) {
            .rule-manager-content {
                padding: 10px !important;
                gap: 15px !important;
                max-width: 100% !important;
            }
        }

        .rule-panels {
            display: flex;
            gap: 20px;
        }

        .rule-examples-panel {
            flex: 1;
            max-width: 50%;
            min-height: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rule-editor-panel {
            flex: 1;
            max-width: 50%;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-title {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .rule-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            background: #f8fafc;
            transition: border-color 0.3s ease;
        }

        .rule-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .examples-header .panel-title {
            margin: 0;
        }

        .toggle-all-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toggle-all-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .toggle-all-btn:active {
            transform: translateY(0);
        }

        .example-section {
            margin-bottom: 0;
        }

        .example-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            transition: all 0.3s ease;
            user-select: none;
        }

        .example-title:hover {
            background: #e2e8f0;
            color: #2d3748;
        }

        .example-title::before {
            content: "ğŸ“";
            margin-right: 8px;
        }

        .example-title::after {
            content: "â–¼";
            margin-left: auto;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: #718096;
        }

        .example-section.collapsed .example-title::after {
            transform: rotate(-90deg);
        }

        .example-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }

        .example-section.collapsed .example-content {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .example-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            margin-bottom: 10px;
        }

        .example-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
            border-radius: 0 4px 4px 0;
        }

        .example-code .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .example-code .copy-btn:hover {
            background: #667eea;
        }

        .rule-actions {
            display: flex;
            gap: 10px;
            margin-top: 0px;
            flex-wrap: wrap;
        }

        .saved-rules-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .saved-rules-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .saved-rules-header h2 {
            margin: 0 0 0 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            font-size: 1.17em;
        }

        .saved-rules-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            max-height: 1000px;
            overflow-y: auto;
            padding: 0;
            min-height: 100px;
            background: transparent;
            border: none;
        }

        .saved-rules-container.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-30px);
        }

        .rule-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 5px 11.2px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            margin-top: -1px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            overflow: hidden;
        }

        .rule-item-header:first-child {
            margin-top: 0;
        }

        /* å¼ºåˆ¶ä¸ºæ‰€æœ‰æœ€åçš„rule-item-contentæ·»åŠ ä¸‹è¾¹çº¿ - ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§ */
        .rule-tree .rule-item-content:last-child {
            border-bottom: 1px solid #e2e8f0 !important;
            border-left: 1px solid #e2e8f0 !important;
            border-right: 1px solid #e2e8f0 !important;
        }

        /* å¼ºåˆ¶ä¸ºrule-treeç›´æ¥å­å…ƒç´ çš„æœ€åä¸€ä¸ªcontentæ·»åŠ ä¸‹è¾¹çº¿ */
        .rule-tree>div:last-child.rule-item-content {
            border-bottom: 1px solid #e2e8f0 !important;
            border-left: 1px solid #e2e8f0 !important;
            border-right: 1px solid #e2e8f0 !important;
        }

        /* ç¡®ä¿æœ€åä¸€ä¸ªrule-item-headerçš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ rule-item-contentæœ‰ä¸‹è¾¹çº¿ */
        .rule-tree .rule-item-header:nth-last-child(2)+.rule-item-content {
            border-bottom: 1px solid #e2e8f0 !important;
            border-left: 1px solid #e2e8f0 !important;
            border-right: 1px solid #e2e8f0 !important;
        }

        /* é€šç”¨å¼ºåˆ¶æ ·å¼ - ç¡®ä¿ä»»ä½•æƒ…å†µä¸‹æœ€åçš„contentéƒ½æœ‰ä¸‹è¾¹çº¿ */
        div.rule-item-content:last-child {
            border-bottom: 1px solid #e2e8f0 !important;
        }

        .rule-item-header:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .rule-item-name {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            flex-shrink: 0;
        }

        .rule-item-content {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: #e2e8f0;
            background: #2d3748;
            padding: 16px;
            border-left: 1px solid #4a5568;
            border-right: 1px solid #4a5568;
            border-radius: 0 0 8px 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            display: block;
            line-height: 1.6;
        }

        .rule-item.collapsed .rule-item-content {
            display: none;
        }

        .rule-item-content.expanded {
            display: block;
        }



        .rule-item-actions {
            display: flex;
            gap: 0;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .syntax-help {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 0;
        }

        .syntax-help h4 {
            color: #c53030;
            /* margin-bottom: 10px; */
            align-items: baseline;
        }

        .syntax-list {
            list-style: none;
            padding: 0;
        }

        .syntax-list li {
            padding: 5px 0;
            border-bottom: 1px solid #fed7d7;
        }

        .syntax-list li:last-child {
            border-bottom: none;
        }

        .syntax-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 3px;
            color: #2d3748;
        }

        .global-sets-editor {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 0;
        }

        .global-sets-editor h4 {
            margin-bottom: 10px;
        }

        .global-sets-textarea {
            width: 100%;
            min-height: 180px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .global-sets-display {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .global-sets-display h4 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .global-sets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .global-set-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #93c5fd;
        }

        .rule-tree {
            list-style: none;
            padding: 0;
            margin: 0;
            font-family: 'Courier New', monospace;
            border-collapse: collapse;
        }

        .rule-tree-item {
            margin-bottom: 5px;
        }

        /* @media (max-width: 1024px) {
            .rule-panels {
                flex-direction: column;
            }

            .rule-examples-panel,
            .rule-editor-panel {
                max-width: 100%;
                flex: none;
            }
        } */

        @media (max-width: 768px) {
            .rule-manager-header {
                flex-direction: row;
                /* gap: 15px; */
                padding-bottom: 15px;
                align-items: flex-start;
            }

            .rule-manager-header h1 {
                font-size: 1.2rem;
                margin-bottom: 0;
            }

            .rule-panels {
                flex-direction: column;
                gap: 15px;
            }

            .rule-examples-panel,
            .rule-editor-panel {
                max-width: 100%;
                flex: none;
                min-height: auto;
            }

            .rule-textarea {
                min-height: 200px;
            }

            .global-sets-textarea {
                min-height: 180px;
            }
        }

        @media (max-width: 768px) {
            .rule-manager-header {
                padding-bottom: 15px !important;
                margin: 10px !important;
                flex-direction: column !important;
                /* gap: 10px !important; */
            }

            .rule-manager-header h1 {
                font-size: 1.5rem !important;
                /* margin-bottom: 10px !important; */
            }

            .rule-actions {
                display: flex !important;
                flex-direction: row !important;
                gap: 5px !important;
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
                margin-top: 0px !important;
            }

            .rule-actions .btn {
                flex: 1 !important;
                padding: 8px 4px !important;
                font-size: 14px !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                margin: 0 !important;
            }

            .global-actions {
                display: flex !important;
                flex-direction: row !important;
                gap: 5px !important;
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
                margin-top: 0px !important;
            }

            .global-actions .btn {
                flex: 1 !important;
                padding: 8px 4px !important;
                font-size: 14px !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                margin: 0 !important;
            }

            .btn {
                padding: 8px 12px !important;
                font-size: 14px !important;
                min-width: auto !important;
            }

            .rule-examples-panel,
            .rule-editor-panel {
                padding: 15px !important;
                max-width: 100% !important;
                margin: 0 !important;
            }

            .rule-textarea,
            .global-sets-textarea {
                font-size: 0.9rem !important;
                padding: 10px !important;
            }

            .rule-textarea {
                min-height: 240px !important;
            }

            .global-sets-textarea {
                min-height: 150px !important;
            }

            /* .rule-panels {
                flex-direction: column !important;
                gap: 15px !important;
            } */

            /* å·²ä¿å­˜çš„è§„åˆ™åŒºåŸŸåœ¨çª„å±ä¸‹çš„å¸ƒå±€è°ƒæ•´ */
            .saved-rules-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px !important;
            }

            .saved-rules-header h2 {
                margin-bottom: 0 !important;
                width: 100% !important;
            }

            .saved-rules-header>div {
                margin-left: 0 !important;
                width: 100% !important;
                justify-content: space-between !important;
                flex-wrap: nowrap !important;
                gap: 5px !important;
            }

            .saved-rules-header .btn {
                flex: 1 !important;
                padding: 6px 4px !important;
                font-size: 14px !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
        }



        /* å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .btn-icon {
            background: none;
            border: none;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-icon:hover {
            background: #f3f4f6;
        }

        .btn-icon:active {
            background: #e5e7eb;
        }

        /* å°æŒ‰é’®æ ·å¼ */
        .btn-small {
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="rule-manager-container">
        <header class="rule-manager-header">
            <div>
                <h1>è§„åˆ™ç®¡ç†</h1>
                <p>åˆ›å»ºå’Œç®¡ç†å•è¯ç­›é€‰è§„åˆ™</p>
            </div>
            <div class="header-buttons">
            </div>
        </header>

        <!-- ä¸ŠåŠåŒºï¼šå·¦å³å¸ƒå±€ -->
        <div class="rule-manager-content">
            <div class="rule-panels">
                <!-- å·¦ä¾§ï¼šç¤ºä¾‹åŒºåŸŸ -->
                <div class="rule-examples-panel">
                    <div class="examples-header">
                        <h3 class="panel-title">è§„åˆ™ç¤ºä¾‹</h3>
                        <button class="btn btn-small btn-outline" onclick="toggleAllExamples()" title="æ”¶ç¼©/å±•å¼€å…¨éƒ¨ç¤ºä¾‹">
                            <span class="toggle-all-text">â– æ”¶ç¼©å…¨éƒ¨ç¤ºä¾‹</span>
                        </button>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">å››å­—æ¯åŠä»¥ä¸Šå•è¯</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#å››å­—æ¯åŠä»¥ä¸Šå•è¯</span></div>
                                    <div><span style="color: #63b3ed;">:\bLLLL</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…åŒ…å«å››ä¸ªæˆ–æ›´å¤šå­—æ¯çš„å•è¯ã€‚</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong><span
                                        class="syntax-code">:\bLLLL</span>ï¼ˆéƒ¨åˆ†åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong><span
                                        class="syntax-code">L</span>ï¼ˆå…¨å±€é›†åˆï¼ŒåŒ…å«å°å†™å­—æ¯a-zï¼‰</div>
                                <div style="margin-bottom: 8px;">
                                    <strong>æ’åºï¼š</strong><span class="syntax-code">@</span>ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæŒ‰å­—æ¯é¡ºåºæ’åºï¼›<span
                                        class="syntax-code">@-</span>ï¼Œåˆ™è¡¨ç¤ºæŒ‰å­—æ¯é™åºæ’åºã€‚
                                </div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>book, tree, jump, play, hello,
                                    world,
                                    beautiful, wonderful</div>
                                <div style="color: #666; font-size: 0.9em;">æ³¨ï¼šå¦‚éœ€æ°å¥½å››ä¸ªå­—æ¯ï¼Œè¯­æ³•è¯·ä½¿ç”¨ :<span
                                        class="syntax-code"><span style="color: red;">\b</span>LLLL<span
                                            style="color: red;">\e</span></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">åŒè¾…éŸ³å¼€å¤´</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#åŒè¾…éŸ³å¼€å¤´</span></div>
                                    <div><span
                                            style="color: #ed64a6;">BL=={bl,br,cl,cr,dr,fl,fr,gl,gr,pl,pr,sc,sk,sl,sm,sn,sp,st,sw,tr,tw}</span>
                                    </div>
                                    <div><span style="color: #63b3ed;">:\b(BL)</span></div>
                                    <div><span style="color: #f6e05e;">@(BL^)</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…ä»¥åŒè¾…éŸ³å¼€å¤´çš„å•è¯ã€‚</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong><span
                                        class="syntax-code">:\b(BL)</span>ï¼ˆéƒ¨åˆ†åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;">
                                    <strong>é›†åˆï¼š</strong><span class="syntax-code">BL</span>ï¼ˆå±€éƒ¨é›†åˆï¼‰
                                </div>
                                <div style="margin-bottom: 8px;"><strong>æ’åºï¼š</strong>æŒ‰é›†åˆ<span
                                        class="syntax-code">BL</span>åŒ…å«çš„å…ƒç´ åˆ†ç»„æ’åºã€‚</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>black, brown, class, green, play,
                                    tree,
                                    stop, swim</div>
                                <div style="color: #666; font-size: 0.9em;">
                                    æ³¨ï¼š<br>1ã€<span
                                        class="syntax-code">\b</span>è¡¨ç¤ºå•è¯å¼€å¤´ã€‚ï¼ˆæ›´å¤šä½ç½®æ ‡å¿—å‚è§è¯¦ç»†è¯­æ³•å¸®åŠ©ï¼‰<br>2ã€ä¸¤ä¸ªå­—æ¯ä»¥ä¸Šçš„é›†åˆéœ€ç”¨æ‹¬å·å¼•ç”¨ã€‚ï¼ˆå¦‚<span
                                        class="syntax-code">(BL)</span>ï¼‰<br>3ã€å¯ä»¥åœ¨æ’åº<span
                                        class="syntax-code">(BL)</span>å‰æ·»åŠ <span class="syntax-code"
                                        style="background-color: lightyellow;">-</span>è¡¨ç¤ºæŒ‰é›†åˆ<span
                                        class="syntax-code">BL</span>å†…çš„å…ƒç´ é€†åºåˆ†ç»„ã€‚ï¼ˆå¦‚<span
                                        class="syntax-code">-(BL)</span>ï¼‰<br>4ã€æ’åºæ”¯æŒå¤šçº§æ’åºå’Œä½ç½®åŒ¹é…ç¬¦ã€‚ï¼ˆå‚è§è¯¦ç»†è¯­æ³•å¸®åŠ©ï¼‰
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">CVCæ¨¡å¼</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVC</span></div>
                                    <div><span style="color: #68d391;">//è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³ï¼ˆå»yï¼‰</span></div>
                                    <div><span style="color: #ed64a6;">eC==C>>{y}</span></div>
                                    <div><span style="color: #63b3ed;">:\bCV(eC)\e</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>å®Œæ•´åŒ¹é…è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³ï¼ˆå»yï¼‰ç»“æ„çš„ä¸‰å­—æ¯å•è¯ã€‚</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong><span
                                        class="syntax-code">:\bCV(eC)\e</span>ï¼ˆå®Œæ•´åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;">
                                    <strong>é›†åˆï¼š</strong><span class="syntax-code">C</span>ï¼ˆå…¨å±€é›†åˆï¼Œè¾…éŸ³å­—æ¯é›†åˆï¼‰ã€<span
                                        class="syntax-code">V</span>ï¼ˆå…¨å±€é›†åˆï¼Œå…ƒéŸ³å­—æ¯é›†åˆï¼‰ã€<span
                                        class="syntax-code">eC</span>ï¼ˆå±€éƒ¨é›†åˆï¼Œä¸å«<span class="syntax-code">y</span>çš„è¾…éŸ³å­—æ¯é›†åˆï¼‰
                                </div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cat, dog, run, big, hat, pen, sit,
                                    cup
                                </div>
                                <div style="color: #666; font-size: 0.9em;">
                                    æ³¨ï¼š<span class="syntax-code">eC==C>>{y}</span>è¡¨ç¤ºä»é›†åˆ<span
                                        class="syntax-code">C</span>ä¸­å»æ‰<span class="syntax-code">y</span>ï¼Œå¾—åˆ°æ–°çš„å±€éƒ¨é›†åˆ<span
                                        class="syntax-code">eC</span>ã€‚ï¼ˆæ›´å¤šé›†åˆè¿ç®—ç¬¦å‚è§è¯¦ç»†è¯­æ³•å¸®åŠ©ï¼‰</div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)">CVCEæ¨¡å¼ï¼ˆé­”æ³•Eï¼‰</div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVCE</span></div>
                                    <div><span style="color: #68d391;">//è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³-e</span></div>
                                    <div><span style="color: #63b3ed;">:\bCVC"e"\e</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>å®Œæ•´åŒ¹é…è¾…éŸ³-å…ƒéŸ³-è¾…éŸ³-eç»“æ„çš„å››å­—æ¯å•è¯ã€‚</div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong><span
                                        class="syntax-code">:!\bCVC"e"\e</span>ï¼ˆå®Œæ•´åŒ¹é…æ¨¡å¼ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong><span
                                        class="syntax-code">C</span>ã€<span class="syntax-code">V</span>ã€<span
                                        class="syntax-code">"e"</span>ï¼ˆå­—é¢å­—ç¬¦ï¼‰</div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cake, make, bike, home, cute, hope,
                                    time, name</div>
                                <div style="color: #666; font-size: 0.9em;">æ³¨ï¼šä½¿ç”¨åŒå¼•å·<span class="syntax-code"
                                        style="background-color: lightyellow;">"
                                        "</span>è¡¨ç¤ºå­—é¢å­—ç¬¦ï¼Œç”¨äºåŒ¹é…å…·ä½“çš„å­—ç¬¦æˆ–å­—ç¬¦ä¸²ã€‚ï¼ˆå¦‚<span class="syntax-code">"e"</span>ã€<span
                                        class="syntax-code">"tion"</span>ï¼‰</div>
                            </div>
                        </div>
                    </div>

                    <div class="example-section">
                        <div class="example-title" onclick="toggleExample(this)"><span style="color: red;">ç»„åˆè§„åˆ™</span>
                        </div>
                        <div class="example-content">
                            <div class="example-code"
                                style="background-color: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace;">
                                <button class="copy-btn" onclick="copyExample(this)">å¤åˆ¶</button>
                                <div style="line-height: 1.6;">
                                    <div><span style="color: #68d391;">#CVCæˆ–CVCE</span></div>
                                    <div><span style="color: #63b3ed;">::CVC||CVCE</span></div>
                                    <div><span style="color: #f6e05e;">@</span></div>
                                </div>
                            </div>
                            <div class="example-description">
                                <div style="margin-bottom: 8px;"><strong>åŠŸèƒ½ï¼š</strong>åŒ¹é…æ»¡è¶³<span
                                        class="syntax-code">CVC</span>æ¨¡å¼æˆ–<span class="syntax-code">CVCE</span>æ¨¡å¼çš„å•è¯ã€‚
                                </div>
                                <div style="margin-bottom: 8px;"><strong>è¯­æ³•ï¼š</strong><span
                                        class="syntax-code">::CVC||CVCE</span>ï¼ˆåŒå†’å·<span class="syntax-code"
                                        style="background-color: lightyellow;">::</span>è¡¨ç¤ºç»„åˆè§„åˆ™æ¨¡å¼ï¼‰
                                </div>
                                <div style="margin-bottom: 8px;"><strong>é›†åˆï¼š</strong>æ— ï¼ˆç»„åˆè§„åˆ™å¿…é¡»å¼•ç”¨å·²å®šä¹‰çš„è§„åˆ™åï¼‰
                                </div>
                                <div style="margin-bottom: 8px;"><strong>ç¤ºä¾‹ï¼š</strong>cat, dog, run, big, cake, make,
                                    bike,
                                    home</div>
                                <div style="margin-bottom: 8px;"><strong><span
                                            style="color: red;">æ”¯æŒçš„æ“ä½œç¬¦ï¼š</span></strong>
                                </div>
                                <div style="margin-left: 16px;">
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">||</span> - æˆ–ï¼ˆæ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼‰</div>
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">&&</span> - ä¸ï¼ˆåŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼‰</div>
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">!</span> - å·®é›†ï¼ˆæ»¡è¶³å‰è€…ä½†ä¸æ»¡è¶³åè€…ï¼‰</div>
                                    <div style="margin-bottom: 4px;">â€¢ <span class="syntax-code"
                                            style="background-color: lightyellow;">~</span> - å–åï¼ˆå¯¹è§„åˆ™ç»“æœå–åï¼‰</div>
                                </div>
                                <div style="margin-bottom: 12px; color: #666; font-size: 0.9em;">
                                    æ³¨ï¼šæ›´å¤šç»„åˆè§„åˆ™è¯´æ˜å‚è§è¯¦ç»†è¯­æ³•å¸®åŠ©ã€‚</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è§„åˆ™ç¼–è¾‘å™¨ -->
                <div class="rule-editor-panel">
                    <h3 class="panel-title">è§„åˆ™ç¼–è¾‘å™¨</h3>

                    <div class="syntax-help">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4>å¿«é€Ÿè¯­æ³•æç¤º</h4>
                            <button id="detailedHelpBtn" class="btn btn-outline btn-small">è¯¦ç»†è¯­æ³•å¸®åŠ©</button>
                        </div>
                        <ul class="syntax-list">
                            <li><span class="syntax-code">#è§„åˆ™å</span> - å®šä¹‰è§„åˆ™åç§°ï¼ˆå¿…é¡»ï¼Œä»¥<span class="syntax-code">#</span>å¼€å¤´ï¼‰
                            </li>
                            <li><span class="syntax-code">//æ³¨é‡Šå†…å®¹</span> - æ·»åŠ è§„åˆ™æ³¨é‡Šï¼ˆå¯é€‰ï¼Œä»¥<span
                                    class="syntax-code">//</span>å¼€å¤´ï¼‰</li>
                            <li><span class="syntax-code">é›†åˆå=={å…ƒç´ 1,å…ƒç´ 2,...}</span> - å®šä¹‰å±€éƒ¨é›†åˆï¼ˆå¯é€‰ï¼Œå•å­—æ¯é›†åˆåå¿…é¡»å¤§å†™ï¼Œå¤šå­—æ¯é›†åˆåå¤§å°å†™æ•æ„Ÿï¼‰
                            </li>
                            <li><span class="syntax-code">:ç­›é€‰è§„åˆ™</span> - å®šä¹‰åŒ¹é…æ¨¡å¼ï¼ˆå¿…é¡»ï¼Œä»¥<span
                                    class="syntax-code">:</span>æˆ–<span class="syntax-code">::</span>å¼€å¤´ï¼‰
                            </li>
                            <li><span class="syntax-code">@æ’åºè§„åˆ™</span> - å®šä¹‰æ’åºæ–¹å¼ï¼ˆå¯é€‰ï¼Œä»¥<span
                                    class="syntax-code">@</span>æˆ–<span class="syntax-code">@@</span>å¼€å¤´ï¼‰
                            </li>
                        </ul>
                    </div>

                    <!-- å…¨å±€é›†åˆç¼–è¾‘åŒº -->
                    <div class="global-sets-editor">
                        <h4>å…¨å±€é›†åˆå®šä¹‰</h4>
                        <textarea id="globalSetsEditor" class="global-sets-textarea"
                            placeholder="åœ¨æ­¤å®šä¹‰å…¨å±€é›†åˆï¼Œæ¯è¡Œä¸€ä¸ªé›†åˆå®šä¹‰ï¼Œæ ¼å¼ï¼šé›†åˆå=={å…ƒç´ 1,å…ƒç´ 2,...}\nä¾‹å¦‚ï¼š\nC=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}\nV=={a,e,i,o,u}">C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}\nV=={a,e,i,o,u}\nL=={a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}</textarea>
                        <div class="global-actions" style="margin-top: 0px; display: flex; gap: 10px;">
                            <button id="updateGlobalSetsBtn" class="btn btn-primary"
                                style="margin-right: 5px;">æ›´æ–°å…¨å±€é›†åˆ</button>
                            <button id="exportRulesFromGlobalBtn" class="btn btn-secondary">å¯¼å‡ºè§„åˆ™</button>
                            <button id="importRulesFromGlobalBtn" class="btn btn-secondary">å¯¼å…¥è§„åˆ™</button>
                        </div>
                    </div>





                    <textarea id="ruleEditor" class="rule-textarea" placeholder="åœ¨æ­¤è¾“å…¥è§„åˆ™...

æ³¨æ„ï¼š
â€¢ ç­›é€‰è§„åˆ™ä¸­å¯å¼•ç”¨å…¨å±€é›†åˆå’Œå±€éƒ¨é›†åˆã€‚
  â—¦ å±€éƒ¨é›†åˆå¿…é¡»åœ¨å½“å‰è§„åˆ™ä¸­å®šä¹‰æ‰èƒ½å¼•ç”¨ã€‚
  â—¦ å¤šå­—æ¯é›†åˆåå¿…é¡»ä½¿ç”¨ (é›†åˆå) å¼•ç”¨ã€‚
â€¢ ç­›é€‰è§„åˆ™ä¸­å¯ä½¿ç”¨ \ä½ç½®æ ‡å¿— å¼ºåˆ¶ä½ç½®åŒ¹é…ã€‚
  â—¦ \b - å•è¯å¼€å¤´ï¼Œ\e - å•è¯ç»“å°¾
  â—¦ æ›´å¤šå‚è§è¯¦ç»†è¯­æ³•å¸®åŠ©ï¼Œ"></textarea>

                    <div class="rule-actions">
                        <button id="saveRuleBtn" class="btn btn-primary">ä¿å­˜è§„åˆ™</button>
                        <button id="testRuleBtn" class="btn btn-secondary" style="margin-right: 5px;">æµ‹è¯•è§„åˆ™</button>
                        <button id="formatRuleBtn" class="btn btn-secondary">æ ¼å¼åŒ–</button>
                        <button id="clearRuleBtn" class="btn btn-danger">æ¸…ç©ºç¼–è¾‘å™¨</button>

                    </div>
                </div>
            </div>

            <!-- ä¸‹åŠåŒºï¼šå·²ä¿å­˜çš„è§„åˆ™ -->
            <div class="saved-rules-section">
                <div class="saved-rules-header">
                    <h2>å·²ä¿å­˜çš„è§„åˆ™</h2>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button class="btn btn-small btn-outline" onclick="toggleAllSavedRules()" title="æ”¶ç¼©/å±•å¼€å…¨éƒ¨è§„åˆ™">
                            <span class="toggle-all-saved-text">â– æ”¶ç¼©å…¨éƒ¨è§„åˆ™</span>
                        </button>
                        <button id="exportRulesBtn" class="btn btn-secondary">å¯¼å‡ºè§„åˆ™</button>
                        <button id="importRulesBtn" class="btn btn-secondary">å¯¼å…¥è§„åˆ™</button>
                        <button id="clearAllRulesBtn" class="btn btn-danger" onclick="ruleManager.clearAllRules()">
                            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è§„åˆ™
                        </button>
                    </div>
                </div>
                <div class="drag-sort-hint"
                    style="color: #718096; font-size: 14px; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                    <span>â‹®â‹®</span>
                    <span>æ‹–åŠ¨å¯è°ƒæ•´æ’åº</span>
                </div>
                <div id="savedRulesContainer" class="saved-rules-container"></div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="messageContainer" class="message-container"></div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <p>æ­£åœ¨å¤„ç†...</p>
    </div>

    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- å¼•å…¥è‡ªå®šä¹‰è„šæœ¬ -->
    <script src="js/fileUtils.js"></script>
    <script src="js/fileStorage.js"></script>
    <script src="js/ruleEngine.js"></script>
    <script src="js/version.js"></script>
    <script>
        // è§„åˆ™ç®¡ç†é¡µé¢ä¸“ç”¨è„šæœ¬
        class RuleManagerApp {
            constructor() {
                this.ruleEngine = new RuleEngine();
                this.ruleOrder = []; // åˆå§‹åŒ–è§„åˆ™é¡ºåºæ•°ç»„
                this.initializeApp();
            }

            initializeApp() {
                this.bindEvents();
                this.ruleEngine.loadSavedRules();
                this.loadSavedRules();
                this.initializeGlobalSetsEditor();
            }

            // åˆå§‹åŒ–å…¨å±€é›†åˆç¼–è¾‘å™¨
            initializeGlobalSetsEditor() {
                const globalSetsEditor = document.getElementById('globalSetsEditor');
                const savedGlobalSets = JSON.parse(localStorage.getItem('globalSets') || '{}');

                let defaultSets = `C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}
V=={a,e,i,o,u}
L=={a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}`;

                // æ·»åŠ ä¿å­˜çš„è‡ªå®šä¹‰é›†åˆ
                for (const [setName, setValues] of Object.entries(savedGlobalSets)) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½®é›†åˆ
                    const builtinSets = this.ruleEngine.getBuiltinSetNames();
                    if (!builtinSets.includes(setName)) {
                        defaultSets += `\n${setName}=={${setValues.join(',')}}`;
                    }
                }

                globalSetsEditor.value = defaultSets;
            }

            bindEvents() {
                // å¯¼å‡ºè§„åˆ™æŒ‰é’®
                document.getElementById('exportRulesBtn').addEventListener('click', async () => {
                    await this.exportRules();
                });

                // å¯¼å…¥è§„åˆ™æŒ‰é’®
                document.getElementById('importRulesBtn').addEventListener('click', () => {
                    this.importRules();
                });



                // ä¿å­˜è§„åˆ™
                document.getElementById('saveRuleBtn').addEventListener('click', () => {
                    this.saveRule();
                });

                // æµ‹è¯•è§„åˆ™
                document.getElementById('testRuleBtn').addEventListener('click', () => {
                    this.testRule();
                });

                // æ¸…ç©ºç¼–è¾‘å™¨
                document.getElementById('clearRuleBtn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹å—ï¼Ÿ')) {
                        document.getElementById('ruleEditor').value = '';
                    }
                });

                // æ ¼å¼åŒ–è§„åˆ™
                document.getElementById('formatRuleBtn').addEventListener('click', () => {
                    this.formatRule();
                });

                // è§„åˆ™ç¼–è¾‘å™¨ç²˜è´´äº‹ä»¶ - è‡ªåŠ¨æ ¼å¼åŒ–
                document.getElementById('ruleEditor').addEventListener('paste', (event) => {
                    // å»¶è¿Ÿæ‰§è¡Œæ ¼å¼åŒ–ï¼Œç¡®ä¿ç²˜è´´å†…å®¹å·²ç»æ’å…¥
                    setTimeout(() => {
                        this.formatRule();
                    }, 10);
                });

                // æ›´æ–°å…¨å±€é›†åˆ
                document.getElementById('updateGlobalSetsBtn').addEventListener('click', () => {
                    this.updateGlobalSets();
                });

                // å…¨å±€é›†åˆåŒºåŸŸçš„å¯¼å‡ºè§„åˆ™æŒ‰é’®
                document.getElementById('exportRulesFromGlobalBtn').addEventListener('click', async () => {
                    await this.exportRules();
                });

                // å…¨å±€é›†åˆåŒºåŸŸçš„å¯¼å…¥è§„åˆ™æŒ‰é’®
                document.getElementById('importRulesFromGlobalBtn').addEventListener('click', () => {
                    this.importRules();
                });

                // è¯¦ç»†å¸®åŠ©æŒ‰é’®
                document.getElementById('detailedHelpBtn').addEventListener('click', () => {
                    this.showDetailedHelp();
                });

            }

            saveRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();

                if (!ruleText) {
                    this.showMessage('è¯·è¾“å…¥è§„åˆ™å†…å®¹', 'warning');
                    return;
                }

                // æ£€æŸ¥è§„åˆ™åç§°æ˜¯å¦ä»¥#å¼€å¤´
                const lines = ruleText.split('\n');
                const nameMatch = lines[0].match(/^#(.+)$/);
                if (!nameMatch) {
                    this.showMessage('è§„åˆ™åç§°å¿…é¡»ä»¥#å¼€å¤´', 'error');
                    return;
                }

                try {
                    console.log('[DEBUG] å¼€å§‹ä¿å­˜è§„åˆ™ï¼Œè§„åˆ™æ–‡æœ¬:', ruleText);

                    // ç›´æ¥è§£æè§„åˆ™æ–‡æœ¬ï¼ˆæ³¨é‡Šå·²åŒ…å«åœ¨æ–‡æœ¬ä¸­ï¼‰
                    console.log('[DEBUG] è°ƒç”¨ parseRule æ–¹æ³•');
                    const rule = this.ruleEngine.parseRule(ruleText);
                    console.log('[DEBUG] parseRule æˆåŠŸï¼Œè§£æç»“æœ:', rule);

                    // æ£€æŸ¥è§„åˆ™å†²çª
                    console.log('[DEBUG] å¼€å§‹æ£€æŸ¥è§„åˆ™å†²çª');
                    const conflicts = this.checkRuleConflicts(rule);
                    console.log('[DEBUG] è§„åˆ™å†²çªæ£€æŸ¥å®Œæˆï¼Œå†²çªæ•°é‡:', conflicts.length);
                    if (conflicts.length > 0) {
                        const conflictMsg = `æ£€æµ‹åˆ°è§„åˆ™å†²çª:\n${conflicts.join('\n')}`;
                        if (!confirm(`${conflictMsg}\n\næ˜¯å¦ä»è¦ä¿å­˜æ­¤è§„åˆ™ï¼Ÿ`)) {
                            return;
                        }
                    }

                    console.log('[DEBUG] è°ƒç”¨ saveRule æ–¹æ³•ä¿å­˜è§„åˆ™');
                    this.ruleEngine.saveRule(rule);
                    console.log('[DEBUG] è§„åˆ™ä¿å­˜æˆåŠŸï¼Œå¼€å§‹åˆ·æ–°ç•Œé¢');
                    this.loadSavedRules();
                    document.getElementById('ruleEditor').value = '';

                    this.showMessage(`è§„åˆ™ "${rule.name}" ä¿å­˜æˆåŠŸ`, 'success');
                    console.log('[DEBUG] è§„åˆ™ä¿å­˜æµç¨‹å®Œæˆ');

                } catch (error) {
                    console.error('[ERROR] è§„åˆ™ä¿å­˜é”™è¯¯:', error);
                    console.error('[ERROR] é”™è¯¯å †æ ˆ:', error.stack);
                    this.showMessage(`è§„åˆ™ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                }
            }

            testRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();

                if (!ruleText) {
                    this.showMessage('è¯·è¾“å…¥è§„åˆ™å†…å®¹', 'warning');
                    return;
                }

                try {
                    const rule = this.ruleEngine.parseRule(ruleText);

                    const testWords = [
                        // CVC æ¨¡å¼
                        'cat', 'dog', 'big', 'run', 'sit', 'hot',
                        // CVCE æ¨¡å¼
                        'cake', 'bike', 'home', 'cute', 'make', 'time',
                        // åŒè¾…éŸ³å¼€å¤´
                        'black', 'green', 'smart', 'strong', 'place', 'train',
                        // é•¿å•è¯ï¼ˆ10å­—æ¯å†…ï¼‰
                        'beautiful', 'important', 'different', 'wonderful', 'education', 'computer',
                        // å¸¦è¯æ ¹è¯ç¼€
                        'unhappy', 'teacher', 'helpful', 'quickly'
                    ];
                    const testResults = [];

                    for (const word of testWords) {
                        const matches = this.ruleEngine.matchesRule(word, rule);
                        testResults.push(`${word}: ${matches ? 'âœ“' : 'âœ—'}`);
                    }

                    // å°†ç»“æœæŒ‰4åˆ—æ’åˆ—æ˜¾ç¤º
                    const columns = 4;
                    const rows = Math.ceil(testResults.length / columns);
                    let formattedResults = 'æµ‹è¯•ç»“æœ:\n\n';

                    for (let row = 0; row < rows; row++) {
                        const rowItems = [];
                        for (let col = 0; col < columns; col++) {
                            const index = row + col * rows;
                            if (index < testResults.length) {
                                // æ ¼å¼åŒ–æ¯ä¸ªç»“æœï¼Œç¡®ä¿å¯¹é½
                                const result = testResults[index];
                                const paddedResult = result.padEnd(15, ' ');
                                rowItems.push(paddedResult);
                            }
                        }
                        formattedResults += rowItems.join('  ') + '\n';
                    }

                    alert(formattedResults);

                } catch (error) {
                    console.error('è§„åˆ™æµ‹è¯•é”™è¯¯:', error);
                    this.showMessage(`è§„åˆ™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            formatRule() {
                const ruleText = document.getElementById('ruleEditor').value.trim();
                if (!ruleText) return;

                // æ ¼å¼åŒ–è§„åˆ™ï¼šä¸æ·»åŠ ç©ºè¡Œï¼Œä¿æŒç´§å‡‘æ ¼å¼
                const lines = ruleText.split('\n');
                const formattedLines = [];

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed) { // åªä¿ç•™éç©ºè¡Œ
                        formattedLines.push(trimmed);
                    }
                }

                document.getElementById('ruleEditor').value = formattedLines.join('\n');
            }

            // æ’å…¥éæ“ä½œç¬¦


            loadSavedRules() {
                const container = document.getElementById('savedRulesContainer');
                let ruleNames = this.ruleEngine.getRuleNames();

                if (ruleNames.length === 0) {
                    container.className = 'saved-rules-container empty';
                    container.innerHTML = '<div style="color: #a0aec0; font-size: 16px; font-weight: 500;">æš‚æ— ä¿å­˜çš„è§„åˆ™</div>';
                    return;
                }

                container.className = 'saved-rules-container';

                // åŠ è½½è§„åˆ™é¡ºåºé…ç½®
                this.loadRuleOrder();

                // æ¸…ç†ä¸å­˜åœ¨çš„è§„åˆ™
                this.cleanupNonExistentRules(ruleNames);

                // æŒ‰ç…§ä¿å­˜çš„é¡ºåºæ’åºè§„åˆ™
                ruleNames = this.sortRulesByOrder(ruleNames);

                let html = '<div class="rule-tree">';



                // æ¸²æŸ“æ‰€æœ‰è§„åˆ™
                ruleNames.forEach(ruleName => {
                    const rule = this.ruleEngine.getRule(ruleName);
                    if (rule) {
                        html += this.createRuleItemHTML(ruleName, rule);
                    }
                });

                html += '</div>';
                container.innerHTML = html;

                // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½
                if (!container.hasAttribute('data-drag-initialized')) {
                    this.initializeDragAndDrop(container);
                    container.setAttribute('data-drag-initialized', 'true');
                }

                // åŠ¨æ€æ·»åŠ æœ€åä¸€ä¸ªè§„åˆ™çš„ä¸‹è¾¹çº¿
                this.addLastRuleBorder();

                // æ¢å¤è§„åˆ™å±•å¼€/æ”¶ç¼©çŠ¶æ€
                this.restoreSavedRuleStates();

                // æ›´æ–°æ”¶ç¼©å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
                updateToggleAllSavedButtonText();
            }

            // åŠ¨æ€æ·»åŠ æœ€åä¸€ä¸ªè§„åˆ™çš„ä¸‹è¾¹çº¿
            addLastRuleBorder() {
                const ruleTree = document.querySelector('.rule-tree');
                if (!ruleTree) return;

                // ç§»é™¤ä¹‹å‰æ·»åŠ çš„æ ·å¼
                const existingStyles = ruleTree.querySelectorAll('.last-rule-border');
                existingStyles.forEach(el => el.classList.remove('last-rule-border'));

                // æ‰¾åˆ°æ‰€æœ‰çš„rule-item-contentå…ƒç´ 
                const allContents = ruleTree.querySelectorAll('.rule-item-content');
                if (allContents.length === 0) return;

                // è·å–æœ€åä¸€ä¸ªcontentå…ƒç´ 
                const lastContent = allContents[allContents.length - 1];

                // æ·»åŠ ç‰¹æ®Šç±»åå’Œæ ·å¼
                lastContent.classList.add('last-rule-border');
                lastContent.style.borderBottom = '2px solid #e2e8f0';
                lastContent.style.borderLeft = '2px solid #e2e8f0';
                lastContent.style.borderRight = '2px solid #e2e8f0';
            }

            editRule(ruleName) {
                const rule = this.ruleEngine.getRule(ruleName);
                if (!rule) return;

                let ruleText = `#${rule.name}`;

                if (rule.localSets.size > 0) {
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.from(setValues).join(',');
                        ruleText += `\n${setName}=={${values}}`;
                    }
                }

                ruleText += `\n${rule.specificRule}`;

                if (rule.displayRule) {
                    ruleText += `\n${rule.displayRule}`;
                }

                // å¦‚æœæœ‰æ³¨é‡Šï¼Œå°†æ³¨é‡Šæ·»åŠ åˆ°è§„åˆ™æ–‡æœ¬ä¸­
                if (rule.comment) {
                    const lines = ruleText.split('\n');
                    // åœ¨è§„åˆ™åç§°åæ’å…¥æ³¨é‡Šè¡Œ
                    lines.splice(1, 0, `//${rule.comment}`);
                    ruleText = lines.join('\n');
                }

                // å¡«å…¥å®Œæ•´çš„è§„åˆ™æ–‡æœ¬ï¼ˆåŒ…å«æ³¨é‡Šï¼‰
                document.getElementById('ruleEditor').value = ruleText;
                document.getElementById('ruleEditor').focus();
            }

            deleteRule(ruleName) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™ "${ruleName}" å—ï¼Ÿ`)) {
                    this.ruleEngine.deleteRule(ruleName);
                    this.loadSavedRules();
                    this.showMessage(`è§„åˆ™ "${ruleName}" å·²åˆ é™¤`, 'success');
                }
            }

            // ç§»åŠ¨è§„åˆ™åˆ°æœ€å‰
            moveRuleToFirst(ruleName) {
                // ä»å½“å‰ä½ç½®ç§»é™¤è§„åˆ™
                this.ruleOrder = this.ruleOrder.filter(name => name !== ruleName);
                // æ·»åŠ åˆ°æœ€å‰é¢
                this.ruleOrder.unshift(ruleName);
                // ä¿å­˜é¡ºåºå¹¶é‡æ–°åŠ è½½
                this.saveRuleOrder();
                this.loadSavedRules();
                this.showMessage(`è§„åˆ™ "${ruleName}" å·²ç§»åŠ¨åˆ°æœ€å‰`, 'success');
            }

            // ç§»åŠ¨è§„åˆ™åˆ°æœ€å
            moveRuleToLast(ruleName) {
                // ä»å½“å‰ä½ç½®ç§»é™¤è§„åˆ™
                this.ruleOrder = this.ruleOrder.filter(name => name !== ruleName);
                // æ·»åŠ åˆ°æœ€åé¢
                this.ruleOrder.push(ruleName);
                // ä¿å­˜é¡ºåºå¹¶é‡æ–°åŠ è½½
                this.saveRuleOrder();
                this.loadSavedRules();
                this.showMessage(`è§„åˆ™ "${ruleName}" å·²ç§»åŠ¨åˆ°æœ€å`, 'success');
            }

            showMessage(message, type = 'info') {
                const messageContainer = document.getElementById('messageContainer');

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;

                messageContainer.appendChild(messageDiv);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 5000);
            }

            // æŒ‰åç§°åˆ†ç»„è§„åˆ™
            // groupRulesByNameæ–¹æ³•å·²åˆ é™¤ï¼Œé¿å…ä¸æ‰‹åŠ¨åˆ†ç»„åŠŸèƒ½å†²çª

            // åˆ›å»ºè§„åˆ™é¡¹HTML
            createRuleItemHTML(ruleName, rule) {
                const ruleText = this.formatRuleText(rule);
                const commentText = rule.comment ? rule.comment : '';

                return `
                    <div class="rule-item collapsed" data-rule-id="${ruleName}">
                        <div class="rule-item-header" draggable="true" data-rule-name="${ruleName}" onclick="ruleManager.toggleRuleExpansion('${ruleName}')">
                            <div class="rule-item-main">
                                <span class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</span>
                                <span class="rule-item-name">${ruleName}</span>
                                ${commentText ? `<span class="rule-item-comment">// ${commentText}</span>` : ''}
                            </div>
                            <div class="rule-item-actions" onclick="event.stopPropagation()">
                                <span class="rule-item-expand-icon" onclick="ruleManager.toggleRuleExpansion('${ruleName}')"></span>
                                <button class="btn-icon" onclick="ruleManager.moveRuleToFirst('${ruleName}')" title="ç§»åŠ¨åˆ°æœ€å‰">â¤´ï¸</button>
                                <button class="btn-icon" onclick="ruleManager.moveRuleToLast('${ruleName}')" title="ç§»åŠ¨åˆ°æœ€å">â¤µï¸</button>
                                <button class="btn-icon" onclick="ruleManager.editRule('${ruleName}')" title="ç¼–è¾‘è§„åˆ™">âœï¸</button>
                                <button class="btn-icon" onclick="ruleManager.deleteRule('${ruleName}')" title="åˆ é™¤è§„åˆ™">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="rule-item-content">${ruleText}</div>
                    </div>
                `;
            }

            // é‡æ„è§„åˆ™æ–‡æœ¬
            reconstructRuleText(rule) {
                let parts = [`#${rule.name}`];

                // æ·»åŠ å±€éƒ¨é›†åˆå®šä¹‰
                if (rule.localSets && rule.localSets.size > 0) {
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.isArray(setValues) ? setValues : Array.from(setValues);
                        parts.push(`${setName}=={${values.join(',')}}`);
                    }
                }

                // æ·»åŠ ç­›é€‰è§„åˆ™
                if (rule.specificRule) {
                    parts.push(rule.specificRule);
                }

                // æ·»åŠ æ’åºè§„åˆ™
                if (rule.displayRule) {
                    parts.push(rule.displayRule);
                } else {
                    parts.push('@');
                }

                return parts.join(' | ');
            }

            // æ ¼å¼åŒ–è§„åˆ™æ–‡æœ¬ç”¨äºå±•ç¤º
            formatRuleText(rule) {
                let lines = [];

                // è§„åˆ™åç§°
                lines.push(`# ${rule.name}`);

                // æ³¨é‡Š
                if (rule.comment) {
                    lines.push(`// ${rule.comment}`);
                }

                // å±€éƒ¨é›†åˆå®šä¹‰
                if (rule.localSets && rule.localSets.size > 0) {
                    lines.push('');
                    lines.push('# å±€éƒ¨é›†åˆå®šä¹‰:');
                    for (const [setName, setValues] of rule.localSets) {
                        const values = Array.isArray(setValues) ? setValues : Array.from(setValues);
                        lines.push(`${setName} == {${values.join(', ')}}`);
                    }
                }

                // ç­›é€‰è§„åˆ™
                if (rule.specificRule) {
                    lines.push('');
                    lines.push('# ç­›é€‰è§„åˆ™:');
                    lines.push(rule.specificRule);
                }

                // æ’åºè§„åˆ™
                lines.push('');
                lines.push('# æ’åºè§„åˆ™:');
                lines.push(rule.displayRule || '@');

                return lines.join('\n');
            }

            // åˆ‡æ¢è§„åˆ™å±•å¼€çŠ¶æ€
            toggleRuleExpansion(ruleName) {
                const ruleItem = document.querySelector(`[data-rule-id="${ruleName}"]`);
                if (ruleItem) {
                    if (ruleItem.classList.contains('collapsed')) {
                        ruleItem.classList.remove('collapsed');
                        ruleItem.classList.add('expanded');
                    } else {
                        ruleItem.classList.remove('expanded');
                        ruleItem.classList.add('collapsed');
                    }
                    // å›¾æ ‡æ—‹è½¬ç”±CSSæ§åˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®æ–‡æœ¬

                    // ä¿å­˜å±•å¼€/æ”¶ç¼©çŠ¶æ€
                    const savedRuleStates = JSON.parse(localStorage.getItem('savedRuleStates') || '{}');
                    savedRuleStates[ruleName] = ruleItem.classList.contains('collapsed');
                    localStorage.setItem('savedRuleStates', JSON.stringify(savedRuleStates));

                    // æ›´æ–°æ”¶ç¼©å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
                    updateToggleAllSavedButtonText();
                }
            }

            // æ¢å¤è§„åˆ™å±•å¼€/æ”¶ç¼©çŠ¶æ€
            restoreSavedRuleStates() {
                const savedRuleStates = JSON.parse(localStorage.getItem('savedRuleStates') || '{}');
                const ruleItems = document.querySelectorAll('.rule-item');

                ruleItems.forEach(item => {
                    const ruleId = item.dataset.ruleId;
                    if (!ruleId) return;

                    const isCollapsed = savedRuleStates[ruleId];
                    if (isCollapsed !== undefined) {
                        if (isCollapsed) {
                            item.classList.remove('expanded');
                            item.classList.add('collapsed');
                        } else {
                            item.classList.remove('collapsed');
                            item.classList.add('expanded');
                        }
                        // å›¾æ ‡æ—‹è½¬ç”±CSSæ§åˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®æ–‡æœ¬
                    }
                });
            }

            // ä¿å­˜è§„åˆ™æ’åºåˆ°æœ¬åœ°å­˜å‚¨
            saveRuleOrder() {
                const container = document.getElementById('savedRulesContainer');
                const ruleHeaders = container.querySelectorAll('.rule-item-header');
                const ruleOrder = Array.from(ruleHeaders).map(item => item.dataset.ruleName);
                localStorage.setItem('ruleOrder', JSON.stringify(ruleOrder));
            }

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§„åˆ™æ’åº
            loadRuleOrder() {
                const savedOrder = localStorage.getItem('ruleOrder');
                if (savedOrder) {
                    try {
                        return JSON.parse(savedOrder);
                    } catch (e) {
                        console.warn('Failed to parse saved rule order:', e);
                    }
                }
                return [];
            }

            // åº”ç”¨è§„åˆ™æ’åº
            applyRuleOrder(rules) {
                const savedOrder = this.loadRuleOrder();
                if (savedOrder.length === 0) {
                    return rules;
                }

                const orderedRules = {};
                const unorderedRules = {};

                // åˆ†ç¦»å·²æ’åºå’Œæœªæ’åºçš„è§„åˆ™
                for (const [name, rule] of Object.entries(rules)) {
                    if (savedOrder.includes(name)) {
                        orderedRules[name] = rule;
                    } else {
                        unorderedRules[name] = rule;
                    }
                }

                // æŒ‰ä¿å­˜çš„é¡ºåºé‡æ–°æ’åˆ—
                const result = {};
                for (const name of savedOrder) {
                    if (orderedRules[name]) {
                        result[name] = orderedRules[name];
                    }
                }

                // æ·»åŠ æ–°çš„æœªæ’åºè§„åˆ™åˆ°æœ«å°¾
                for (const [name, rule] of Object.entries(unorderedRules)) {
                    result[name] = rule;
                }

                return result;
            }

            // æ›´æ–°å…¨å±€é›†åˆ
            updateGlobalSets() {
                const globalSetsText = document.getElementById('globalSetsEditor').value.trim();

                if (!globalSetsText) {
                    this.showMessage('è¯·è¾“å…¥å…¨å±€é›†åˆå®šä¹‰', 'warning');
                    return;
                }

                try {
                    // è§£æå…¨å±€é›†åˆå®šä¹‰
                    const lines = globalSetsText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    const newGlobalSets = new Map();
                    const errorLines = [];

                    for (const line of lines) {
                        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å•ç­‰å·è€ŒéåŒç­‰å·
                        if (line.includes('=') && !line.includes('==') && line.includes('{')) {
                            errorLines.push(`é›†åˆå®šä¹‰éœ€è¦ä½¿ç”¨åŒç­‰å·(==): ${line}`);
                            continue;
                        }

                        if (line.includes('==')) {
                            const [setName, setDef] = line.split('==');
                            const cleanSetName = setName.trim();

                            // éªŒè¯é›†åˆåç§°
                            if (cleanSetName.length === 1) {
                                // å•å­—æ¯é›†åˆåå¿…é¡»æ˜¯å¤§å†™
                                if (!/^[A-Z]$/.test(cleanSetName)) {
                                    throw new Error(`å•å­—æ¯é›†åˆå "${cleanSetName}" å¿…é¡»æ˜¯å¤§å†™å­—æ¯`);
                                }
                            } else {
                                // å¤šå­—æ¯é›†åˆååœ¨å¼•ç”¨æ—¶éœ€è¦ç”¨æ‹¬å·
                                console.warn(`é›†åˆåç§° "${cleanSetName}" é•¿åº¦è¶…è¿‡1ä¸ªå­—ç¬¦ï¼Œåœ¨å¼•ç”¨æ—¶è¯·ä½¿ç”¨æ‹¬å·ï¼š(${cleanSetName})`);
                            }

                            const setValues = this.parseSetValues(setDef.trim());
                            newGlobalSets.set(cleanSetName, setValues);
                        }
                    }

                    // å¦‚æœæœ‰é”™è¯¯è¡Œï¼Œæ˜¾ç¤ºé”™è¯¯å¹¶ç»ˆæ­¢æ›´æ–°
                    if (errorLines.length > 0) {
                        throw new Error(`å­˜åœ¨æ ¼å¼é”™è¯¯çš„é›†åˆå®šä¹‰:\n${errorLines.join('\n')}`);
                    }

                    // æ›´æ–°RuleEngineä¸­çš„å…¨å±€é›†åˆ
                    this.ruleEngine.updateGlobalSets(newGlobalSets);

                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const globalSetsData = {};
                    for (const [setName, setValues] of newGlobalSets) {
                        globalSetsData[setName] = Array.from(setValues);
                    }
                    localStorage.setItem('globalSets', JSON.stringify(globalSetsData));

                    // åˆ·æ–°ç¼–è¾‘å™¨å†…å®¹ï¼Œæ˜¾ç¤ºå»é‡åçš„é›†åˆ
                    this.refreshGlobalSetsEditor();

                    this.showMessage('å…¨å±€é›†åˆæ›´æ–°æˆåŠŸ', 'success');

                } catch (error) {
                    console.error('å…¨å±€é›†åˆæ›´æ–°é”™è¯¯:', error);
                    this.showMessage(`å…¨å±€é›†åˆæ›´æ–°å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // è§£æé›†åˆå€¼
            parseSetValues(setDef) {
                if (setDef.startsWith('{') && setDef.endsWith('}')) {
                    const content = setDef.slice(1, -1);
                    return new Set(content.split(',').map(item => item.trim()).filter(item => item.length > 0));
                }
                throw new Error(`é›†åˆå®šä¹‰æ ¼å¼é”™è¯¯: ${setDef}`);
            }

            // åˆå§‹åŒ–æ‹–æ‹½æ’åº
            initializeDragAndDrop(container) {
                let draggedElement = null;

                container.addEventListener('dragstart', (e) => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»rule-item-headeræˆ–å…¶å­å…ƒç´ ï¼ˆå¦‚æ‹–æ‹½å¥æŸ„ï¼‰å¼€å§‹æ‹–æ‹½
                    const headerElement = e.target.closest('.rule-item-header');

                    if (headerElement) {
                        draggedElement = headerElement;
                        headerElement.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', headerElement.outerHTML);
                    }
                });

                container.addEventListener('dragend', (e) => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»rule-item-headeræˆ–å…¶å­å…ƒç´ ç»“æŸæ‹–æ‹½
                    const headerElement = e.target.closest('.rule-item-header');

                    if (headerElement) {
                        headerElement.classList.remove('dragging');
                        // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æŒ‡ç¤ºå™¨
                        container.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });

                        draggedElement = null;
                    }
                });

                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    // æ¸…é™¤ä¹‹å‰çš„æŒ‡ç¤ºå™¨
                    container.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });

                    if (draggedElement) {
                        // ç®€åŒ–çš„è§„åˆ™é¡¹æ‹–æ‹½é€»è¾‘
                        const afterElement = this.getDragAfterElement(container, e.clientY);
                        if (afterElement) {
                            afterElement.classList.add('drag-over');
                        }
                    }
                });

                container.addEventListener('drop', (e) => {
                    e.preventDefault();

                    if (draggedElement) {
                        const afterElement = this.getDragAfterElement(container, e.clientY);

                        // è·å–æ‹–æ‹½å…ƒç´ æ‰€åœ¨çš„rule-itemå®¹å™¨
                        const draggedRuleItem = draggedElement.closest('.rule-item');
                        const draggedRuleName = draggedElement.dataset.ruleName;

                        if (draggedRuleItem && draggedRuleName) {
                            // ç®€åŒ–çš„æ‹–æ‹½å¤„ç†é€»è¾‘
                            if (afterElement) {
                                const afterRuleItem = afterElement.closest('.rule-item');
                                if (afterRuleItem) {
                                    // åœ¨ç›®æ ‡å…ƒç´ ä¹‹å‰æ’å…¥
                                    const targetContainer = afterRuleItem.parentNode;
                                    if (targetContainer && targetContainer.contains(draggedRuleItem)) {
                                        targetContainer.insertBefore(draggedRuleItem, afterRuleItem);
                                        // æ›´æ–°è§„åˆ™é¡ºåº
                                        this.updateRuleOrder();
                                        this.showMessage('è§„åˆ™ä½ç½®å·²æ›´æ–°', 'success');
                                    }
                                }
                            } else {
                                // ç§»åŠ¨åˆ°æœ«å°¾
                                const targetContainer = draggedRuleItem.parentNode;
                                if (targetContainer) {
                                    targetContainer.appendChild(draggedRuleItem);
                                    // æ›´æ–°è§„åˆ™é¡ºåº
                                    this.updateRuleOrder();
                                    this.showMessage('è§„åˆ™ä½ç½®å·²æ›´æ–°', 'success');
                                }
                            }
                        }

                        // æ¸…é™¤æ‹–æ‹½æŒ‡ç¤ºå™¨
                        container.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                    }
                });

                container.addEventListener('dragleave', (e) => {
                    // å½“æ‹–æ‹½ç¦»å¼€å®¹å™¨æ—¶æ¸…é™¤æŒ‡ç¤ºå™¨
                    if (!container.contains(e.relatedTarget)) {
                        container.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                    }
                });
            }

            // è·å–æ‹–æ‹½åçš„ä½ç½®
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.rule-item-header:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }



            // æ›´æ–°è§„åˆ™é¡ºåº
            updateRuleOrder() {
                const container = document.querySelector('.saved-rules-container');
                if (!container) return;

                // è·å–æ‰€æœ‰è§„åˆ™é¡¹
                const ruleItems = [...container.querySelectorAll('.rule-item')];

                // æå–è§„åˆ™åç§°
                const newOrder = ruleItems.map(item => {
                    const header = item.querySelector('.rule-item-header[data-rule-name]');
                    return header ? header.getAttribute('data-rule-name') : null;
                }).filter(name => name !== null);

                // æ›´æ–°è§„åˆ™é¡ºåº
                this.ruleOrder = newOrder;
                this.saveRuleOrder();
            }



            // åˆ†ç»„ç®¡ç†åŠŸèƒ½
            // ä¿å­˜è§„åˆ™é¡ºåºé…ç½®
            saveRuleOrder() {
                localStorage.setItem('ruleOrder', JSON.stringify(this.ruleOrder));
            }

            // åŠ è½½è§„åˆ™é¡ºåºé…ç½®
            loadRuleOrder() {
                const savedOrder = localStorage.getItem('ruleOrder');
                if (savedOrder) {
                    this.ruleOrder = JSON.parse(savedOrder);
                } else {
                    this.ruleOrder = [];
                }
            }

            // æŒ‰ç…§ä¿å­˜çš„é¡ºåºæ’åºè§„åˆ™
            sortRulesByOrder(ruleNames) {
                const orderedRules = [];
                const unorderedRules = [...ruleNames];

                // å…ˆæ·»åŠ å·²æ’åºçš„è§„åˆ™
                this.ruleOrder.forEach(ruleName => {
                    const index = unorderedRules.indexOf(ruleName);
                    if (index !== -1) {
                        orderedRules.push(ruleName);
                        unorderedRules.splice(index, 1);
                    }
                });

                // å†æ·»åŠ æ–°çš„æœªæ’åºè§„åˆ™
                orderedRules.push(...unorderedRules);

                // æ›´æ–°è§„åˆ™é¡ºåº
                this.ruleOrder = orderedRules;
                this.saveRuleOrder();

                return orderedRules;
            }





            // æ¸…ç†ä¸å­˜åœ¨çš„è§„åˆ™
            cleanupNonExistentRules(ruleNames) {
                this.ruleOrder = this.ruleOrder.filter(ruleName => ruleNames.includes(ruleName));
            }

            // æ£€æŸ¥è§„åˆ™å†²çª
            checkRuleConflicts(newRule) {
                const conflicts = [];
                const existingRules = this.ruleEngine.getRuleNames();

                // æ£€æŸ¥åç§°å†²çª
                if (existingRules.includes(newRule.name)) {
                    conflicts.push(`è§„åˆ™åç§° "${newRule.name}" å·²å­˜åœ¨`);
                }

                // æ£€æŸ¥é›†åˆå®šä¹‰å†²çª
                for (const [setName, setValues] of newRule.localSets) {
                    for (const existingRuleName of existingRules) {
                        const existingRule = this.ruleEngine.getRule(existingRuleName);
                        if (existingRule.localSets.has(setName)) {
                            const existingValues = existingRule.localSets.get(setName);
                            const newValues = Array.from(setValues).sort();
                            const oldValues = Array.from(existingValues).sort();

                            if (JSON.stringify(newValues) !== JSON.stringify(oldValues)) {
                                conflicts.push(`é›†åˆ "${setName}" åœ¨è§„åˆ™ "${existingRuleName}" ä¸­æœ‰ä¸åŒå®šä¹‰`);
                            }
                        }
                    }
                }

                return conflicts;
            }

            // æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è§„åˆ™
            clearAllRules() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è§„åˆ™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    // æ¸…é™¤RuleEngineä¸­çš„æ‰€æœ‰è§„åˆ™
                    let ruleNames = this.ruleEngine.getRuleNames();
                    ruleNames.forEach(ruleName => {
                        this.ruleEngine.deleteRule(ruleName);
                    });

                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„è§„åˆ™æ•°æ®
                    localStorage.removeItem('wordFilterRules');
                    localStorage.removeItem('ruleOrder');

                    // åˆ·æ–°æ˜¾ç¤º
                    this.loadSavedRules();

                    this.showMessage('æ‰€æœ‰è§„åˆ™å·²æ¸…é™¤', 'success');
                }
            }

            // æ˜¾ç¤ºè¯¦ç»†å¸®åŠ©
            showDetailedHelp() {
                window.open('syntax-help.html', '_blank');
            }

            // è·å–æ‰€æœ‰å…¨å±€é›†åˆ
            getAllGlobalSets() {
                // ç›´æ¥ä»RuleEngineè·å–çœŸæ­£çš„å…¨å±€é›†åˆ
                return this.ruleEngine.getGlobalSets();
            }

            // åˆ·æ–°å…¨å±€é›†åˆç¼–è¾‘å™¨å†…å®¹
            refreshGlobalSetsEditor() {
                const globalSetsEditor = document.getElementById('globalSetsEditor');
                const savedGlobalSets = JSON.parse(localStorage.getItem('globalSets') || '{}');

                let editorContent = '';
                for (const [setName, setValues] of Object.entries(savedGlobalSets)) {
                    if (Array.isArray(setValues)) {
                        editorContent += `${setName}=={${setValues.join(',')}}\n`;
                    }
                }

                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å…¨å±€é›†åˆï¼Œä½¿ç”¨é»˜è®¤å€¼
                if (!editorContent.trim()) {
                    editorContent = 'C=={b,c,d,f,g,h,j,k,l,m,n,p,q,r,s,t,v,w,x,y,z}\nV=={a,e,i,o,u}\nL=={a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z}';
                }

                globalSetsEditor.value = editorContent.trim();
            }

            /**
             * å¯¼å‡ºè§„åˆ™åˆ°æ–‡ä»¶
             */
            async exportRules() {
                try {
                    // æŒ‰ç…§å½“å‰æ’åºé¡ºåºè·å–è§„åˆ™
                    const orderedRules = this.getOrderedRulesForExport();
                    // ä¸´æ—¶ä¿å­˜å½“å‰è§„åˆ™åˆ°ruleEngineï¼Œä»¥ä¾¿å¯¼å‡ºæ—¶åŒ…å«å…¨å±€é›†åˆ
                    const originalRules = this.ruleEngine.rules;
                    this.ruleEngine.rules = orderedRules;

                    const success = await this.ruleEngine.exportRulesToFile();

                    // æ¢å¤åŸå§‹è§„åˆ™
                    this.ruleEngine.rules = originalRules;

                    if (success) {
                        this.showMessage('è§„åˆ™å¯¼å‡ºæˆåŠŸï¼', 'success');
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œä¸æ˜¾ç¤ºä»»ä½•æ¶ˆæ¯
                        return;
                    }
                    console.error('å¯¼å‡ºè§„åˆ™å¤±è´¥:', error);
                    this.showMessage('å¯¼å‡ºè§„åˆ™å¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * æŒ‰ç…§å½“å‰æ˜¾ç¤ºé¡ºåºè·å–è§„åˆ™ç”¨äºå¯¼å‡º
             */
            getOrderedRulesForExport() {
                const container = document.getElementById('savedRulesContainer');
                const ruleHeaders = container.querySelectorAll('.rule-item-header');
                const orderedRules = new Map();

                // æŒ‰ç…§å½“å‰æ˜¾ç¤ºé¡ºåºæ·»åŠ è§„åˆ™
                Array.from(ruleHeaders).forEach(header => {
                    const ruleName = header.dataset.ruleName;
                    const rule = this.ruleEngine.getRule(ruleName);
                    if (rule) {
                        orderedRules.set(ruleName, rule);
                    }
                });

                return orderedRules;
            }

            /**
             * ä»æ–‡ä»¶å¯¼å…¥è§„åˆ™
             */
            importRules() {
                try {
                    this.ruleEngine.importRulesFromFile();

                    // ç›‘å¬è§„åˆ™æ›´æ–°äº‹ä»¶
                    window.addEventListener('rulesUpdated', () => {
                        this.loadSavedRules();
                        this.showMessage('è§„åˆ™å¯¼å…¥æˆåŠŸï¼', 'success');
                    }, { once: true });

                    // ç›‘å¬å…¨å±€é›†åˆæ›´æ–°äº‹ä»¶
                    window.addEventListener('globalSetsUpdated', () => {
                        this.refreshGlobalSetsEditor();
                    }, { once: true });
                } catch (error) {
                    console.error('å¯¼å…¥è§„åˆ™å¤±è´¥:', error);
                    this.showMessage('å¯¼å…¥è§„åˆ™å¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * åŠ è½½å†…ç½®ç¤ºä¾‹
             */
            loadExamples() {
                // ç¤ºä¾‹å·²åœ¨HTMLä¸­é™æ€å®šä¹‰ï¼Œæ­¤æ–¹æ³•ç”¨äºåŠ¨æ€åŠ è½½æˆ–æ›´æ–°ç¤ºä¾‹
                console.log('ç¤ºä¾‹å·²åŠ è½½');
            }

            /**
             * åº”ç”¨ç¤ºä¾‹åˆ°ç¼–è¾‘å™¨
             * @param {string} rule - è§„åˆ™å†…å®¹
             */
            applyExample(rule) {
                const ruleEditor = document.getElementById('ruleEditor');
                if (ruleEditor) {
                    ruleEditor.value = rule;
                    this.updatePreview();
                }
            }

            /**
             * æ›´æ–°é¢„è§ˆé¢æ¿
             */
            updatePreview() {
                // å®æ—¶é¢„è§ˆåŠŸèƒ½ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§„åˆ™é¢„è§ˆé€»è¾‘
                const ruleText = document.getElementById('ruleEditor').value.trim();
                if (ruleText) {
                    try {
                        // è¿™é‡Œå¯ä»¥æ·»åŠ è§„åˆ™é¢„è§ˆé€»è¾‘
                        console.log('é¢„è§ˆæ›´æ–°:', ruleText);
                    } catch (error) {
                        console.error('é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                    }
                }
            }

            /**
             * æ˜¾ç¤ºè¯­æ³•å¸®åŠ©
             */
            showSyntaxHelp() {
                window.open('syntax-help.html', '_blank');
            }

            /**
             * åˆ‡æ¢é¢æ¿æ˜¾ç¤º
             * @param {string} panel - é¢æ¿åç§°
             */
            togglePanel(panel) {
                const panelElement = document.querySelector(`.${panel}-panel`);
                if (panelElement) {
                    panelElement.classList.toggle('hidden');
                }
            }
        } // RuleManagerApp ç±»ç»“æŸ

        // åˆå§‹åŒ–åº”ç”¨
        let ruleManager;
        let isNarrowScreen = false;

        document.addEventListener('DOMContentLoaded', () => {
            ruleManager = new RuleManagerApp();
            window.ruleManager = ruleManager; // ä½¿ruleManagerå…¨å±€å¯è®¿é—®

            // æ¢å¤ç¤ºä¾‹çš„å±•å¼€/æ”¶ç¼©çŠ¶æ€
            restoreExampleStates();

            // åˆå§‹åŒ–å“åº”å¼ç›‘å¬
            handleResponsiveExamples();
            window.addEventListener('resize', handleResponsiveExamples);

            // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ æœ€åä¸€ä¸ªè§„åˆ™çš„è¾¹æ¡†
            setTimeout(() => {
                ruleManager.addLastRuleBorder();
            }, 500);
        });

        // å¤„ç†å“åº”å¼ç¤ºä¾‹æ”¶ç¼©/å±•å¼€
        function handleResponsiveExamples() {
            const currentIsNarrow = window.innerWidth <= 768;

            // ä»å®½å±åˆ‡æ¢åˆ°çª„å±æ—¶è‡ªåŠ¨æ”¶ç¼©
            if (!isNarrowScreen && currentIsNarrow) {
                collapseAllExamples();
            }
            // ä»çª„å±åˆ‡æ¢åˆ°å®½å±æ—¶è‡ªåŠ¨å±•å¼€
            else if (isNarrowScreen && !currentIsNarrow) {
                expandAllExamples();
            }

            isNarrowScreen = currentIsNarrow;
        }

        // æ”¶ç¼©æ‰€æœ‰ç¤ºä¾‹ï¼ˆä¸ä¿å­˜çŠ¶æ€ï¼‰
        function collapseAllExamples() {
            const exampleSections = document.querySelectorAll('.example-section');

            exampleSections.forEach(section => {
                section.classList.add('collapsed');
            });

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // å±•å¼€æ‰€æœ‰ç¤ºä¾‹ï¼ˆä¸ä¿å­˜çŠ¶æ€ï¼‰
        function expandAllExamples() {
            const exampleSections = document.querySelectorAll('.example-section');

            exampleSections.forEach(section => {
                section.classList.remove('collapsed');
            });

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // å…¨å±€æ”¶ç¼©/å±•å¼€å‡½æ•°
        function toggleExample(titleElement) {
            const exampleSection = titleElement.parentElement;
            exampleSection.classList.toggle('collapsed');

            // ä¿å­˜å±•å¼€/æ”¶ç¼©çŠ¶æ€åˆ°localStorage
            const titleText = titleElement.textContent.trim();
            const isCollapsed = exampleSection.classList.contains('collapsed');
            const exampleStates = JSON.parse(localStorage.getItem('exampleStates') || '{}');
            exampleStates[titleText] = isCollapsed;
            localStorage.setItem('exampleStates', JSON.stringify(exampleStates));

            // æ›´æ–°æ”¶ç¼©/å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ¢å¤ç¤ºä¾‹çš„å±•å¼€/æ”¶ç¼©çŠ¶æ€
        function restoreExampleStates() {
            const exampleStates = JSON.parse(localStorage.getItem('exampleStates') || '{}');
            const exampleSections = document.querySelectorAll('.example-section');

            exampleSections.forEach(section => {
                const titleElement = section.querySelector('.example-title');
                const titleText = titleElement.textContent.trim();

                if (exampleStates[titleText]) {
                    section.classList.add('collapsed');
                }
            });

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ”¶ç¼©/å±•å¼€å…¨éƒ¨ç¤ºä¾‹
        function toggleAllExamples() {
            const exampleSections = document.querySelectorAll('.example-section');
            const toggleBtn = document.querySelector('.toggle-all-btn .toggle-all-text');

            // æ£€æŸ¥å½“å‰çŠ¶æ€ï¼šå¦‚æœæ‰€æœ‰ç¤ºä¾‹éƒ½æ˜¯æ”¶ç¼©çš„ï¼Œåˆ™å±•å¼€å…¨éƒ¨ï¼›å¦åˆ™æ”¶ç¼©å…¨éƒ¨
            const allCollapsed = Array.from(exampleSections).every(section =>
                section.classList.contains('collapsed')
            );

            const exampleStates = {};

            exampleSections.forEach(section => {
                const titleElement = section.querySelector('.example-title');
                const titleText = titleElement.textContent.trim();

                if (allCollapsed) {
                    // å±•å¼€å…¨éƒ¨
                    section.classList.remove('collapsed');
                    exampleStates[titleText] = false;
                } else {
                    // æ”¶ç¼©å…¨éƒ¨
                    section.classList.add('collapsed');
                    exampleStates[titleText] = true;
                }
            });

            // ä¿å­˜çŠ¶æ€
            localStorage.setItem('exampleStates', JSON.stringify(exampleStates));

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }

        // æ›´æ–°æ”¶ç¼©/å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
        function updateToggleAllButtonText() {
            const exampleSections = document.querySelectorAll('.example-section');
            const toggleBtn = document.querySelector('.examples-header .btn-outline .toggle-all-text');

            if (!toggleBtn) return;

            const allCollapsed = Array.from(exampleSections).every(section =>
                section.classList.contains('collapsed')
            );

            toggleBtn.textContent = allCollapsed ? 'â• å±•å¼€å…¨éƒ¨ç¤ºä¾‹' : 'â– æ”¶ç¼©å…¨éƒ¨ç¤ºä¾‹';
        }

        // æ”¶ç¼©/å±•å¼€å…¨éƒ¨å·²ä¿å­˜è§„åˆ™
        function toggleAllSavedRules() {
            const ruleItems = document.querySelectorAll('.rule-item');
            const toggleBtn = document.querySelector('.toggle-all-saved-text');

            if (ruleItems.length === 0) return;

            // æ£€æŸ¥å½“å‰çŠ¶æ€ï¼šå¦‚æœæ‰€æœ‰è§„åˆ™éƒ½æ˜¯æ”¶ç¼©çš„ï¼Œåˆ™å±•å¼€å…¨éƒ¨ï¼›å¦åˆ™æ”¶ç¼©å…¨éƒ¨
            const allCollapsed = Array.from(ruleItems).every(item =>
                item.classList.contains('collapsed')
            );

            const savedRuleStates = {};

            ruleItems.forEach(item => {
                const ruleId = item.dataset.ruleId;
                if (!ruleId) return;

                if (allCollapsed) {
                    // å±•å¼€å…¨éƒ¨
                    item.classList.remove('collapsed');
                    item.classList.add('expanded');
                    savedRuleStates[ruleId] = false;
                } else {
                    // æ”¶ç¼©å…¨éƒ¨
                    item.classList.remove('expanded');
                    item.classList.add('collapsed');
                    savedRuleStates[ruleId] = true;
                }
            });

            // ä¿å­˜çŠ¶æ€
            localStorage.setItem('savedRuleStates', JSON.stringify(savedRuleStates));

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            updateToggleAllSavedButtonText();
        }

        // æ›´æ–°å·²ä¿å­˜è§„åˆ™æ”¶ç¼©/å±•å¼€å…¨éƒ¨æŒ‰é’®çš„æ–‡æœ¬
        function updateToggleAllSavedButtonText() {
            const ruleItems = document.querySelectorAll('.rule-item');
            const toggleBtn = document.querySelector('.saved-rules-header .btn-outline .toggle-all-saved-text');

            if (!toggleBtn) return;

            if (ruleItems.length === 0) {
                toggleBtn.textContent = 'â– æ”¶ç¼©å…¨éƒ¨è§„åˆ™';
                return;
            }

            const allCollapsed = Array.from(ruleItems).every(item =>
                item.classList.contains('collapsed')
            );

            toggleBtn.textContent = allCollapsed ? 'â• å±•å¼€å…¨éƒ¨è§„åˆ™' : 'â– æ”¶ç¼©å…¨éƒ¨è§„åˆ™';
        }

        // å…¨å±€å¤åˆ¶å‡½æ•°
        function copyExample(button) {
            const codeBlock = button.parentElement;

            // å…‹éš†ä»£ç å—ä»¥é¿å…ä¿®æ”¹åŸå§‹å†…å®¹
            const clonedBlock = codeBlock.cloneNode(true);

            // ä»å…‹éš†çš„å—ä¸­ç§»é™¤å¤åˆ¶æŒ‰é’®
            const clonedButton = clonedBlock.querySelector('button');
            if (clonedButton) {
                clonedButton.remove();
            }

            // è·å–çº¯æ–‡æœ¬å†…å®¹
            const textToCopy = clonedBlock.textContent.trim();

            if (!textToCopy) {
                button.textContent = 'æ— å†…å®¹';
                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶';
                }, 2000);
                return;
            }

            // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    button.textContent = 'å·²å¤åˆ¶';
                    button.style.background = '#48bb78';
                    setTimeout(() => {
                        button.textContent = 'å¤åˆ¶';
                        button.style.background = '#4a5568';
                    }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(textToCopy, button);
                });
            } else {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopy(textToCopy, button);
            }
        }

        function fallbackCopy(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                button.textContent = 'å·²å¤åˆ¶';
                button.style.background = '#48bb78';
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.textContent = 'å¤åˆ¶å¤±è´¥';
            }

            document.body.removeChild(textArea);
            setTimeout(() => {
                button.textContent = 'å¤åˆ¶';
                button.style.background = '#4a5568';
            }, 2000);
        }
    </script>
</body>

</html>