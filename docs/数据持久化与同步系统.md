# 数据持久化与同步系统功能详细文档

## 概述

数据持久化与同步系统是单词筛选工具的数据管理核心，负责用户数据的存储、同步和备份。该系统采用多层次存储策略，结合浏览器本地存储和文件系统，为用户提供可靠的数据保护和便捷的数据管理体验。

## 核心功能架构

### 1. 多层次存储架构

#### 1.1 存储层级设计
**三层存储结构：**

**第一层：内存存储**
- 运行时数据缓存
- 快速访问和操作
- 临时状态管理

**第二层：浏览器本地存储 (localStorage)**
- 持久化用户配置
- 自动保存机制
- 跨会话数据保持

**第三层：文件系统存储**
- 数据备份和导出
- 跨设备数据迁移
- 长期数据归档

#### 1.2 存储策略分配
```
数据类型分配策略
├── 规则数据
│   ├── 内存：当前编辑的规则
│   ├── localStorage：已保存的规则库
│   └── 文件：规则备份和分享
├── 全局集合
│   ├── 内存：运行时集合数据
│   ├── localStorage：用户自定义集合
│   └── 文件：集合库导出
├── 用户偏好
│   ├── 内存：当前会话设置
│   ├── localStorage：界面状态偏好
│   └── 文件：配置文件导出
└── 临时数据
    ├── 内存：筛选结果、文件处理状态
    └── sessionStorage：会话级临时数据
```

### 2. 浏览器本地存储系统

#### 2.1 localStorage 数据管理
**存储数据类型：**

**规则数据存储 (wordFilterRules)**
```json
{
  "规则名称1": {
    "name": "规则名称1",
    "comment": "规则注释",
    "localSets": [["集合名", ["值1", "值2"]]],
    "specificRule": "具体规则内容",
    "displayRule": "显示用规则"
  },
  "规则名称2": { ... }
}
```

**全局集合存储 (globalSets)**
```json
{
  "元音": ["a", "e", "i", "o", "u"],
  "辅音": ["b", "c", "d", "f", "g", ...],
  "自定义集合": ["值1", "值2", "值3"]
}
```

**规则排序存储 (ruleOrder)**
```json
["规则名称1", "规则名称2", "规则名称3"]
```

**界面状态存储**
```json
{
  "exampleStates": {
    "示例1": true,
    "示例2": false
  },
  "savedRuleStates": {
    "规则1": "expanded",
    "规则2": "collapsed"
  }
}
```

#### 2.2 自动保存机制
**保存触发条件：**
- 规则创建或修改时
- 全局集合变更时
- 规则排序调整时
- 界面状态改变时

**保存流程：**
```
数据变更检测 → 数据序列化 → localStorage写入 → 错误处理 → 状态同步
```

**数据同步策略：**
- 实时同步：关键数据立即保存
- 批量同步：界面状态定期保存
- 冲突处理：时间戳优先策略

#### 2.3 数据完整性保护
**数据验证机制：**
```
数据读取 → 格式验证 → 内容校验 → 错误恢复 → 数据加载
```

**错误恢复策略：**
- 格式错误：使用默认数据结构
- 部分损坏：保留有效部分
- 完全损坏：重置为初始状态

### 3. 文件存储管理系统

#### 3.1 FileStorageManager 核心功能
**文件管理器架构：**
```
FileStorageManager
├── 规则文件管理
│   ├── saveRulesToFile()
│   ├── loadRulesFromFile()
│   └── 规则数据序列化
├── 全局集合管理
│   ├── saveGlobalSetsToFile()
│   ├── loadGlobalSetsFromFile()
│   └── 集合数据序列化
├── 文件操作接口
│   ├── downloadFileWithPicker()
│   ├── createFileInput()
│   └── 文件格式处理
└── 兼容性处理
    ├── File System Access API
    ├── 传统下载方式
    └── 降级处理机制
```

#### 3.2 智能文件格式设计
**新格式文件结构：**
```json
{
  "globalSets": {
    "元音": ["a", "e", "i", "o", "u"],
    "辅音": ["b", "c", "d", ...]
  },
  "rules": {
    "规则名称": {
      "name": "规则名称",
      "comment": "规则注释",
      "localSets": [["集合名", ["值1", "值2"]]],
      "specificRule": "具体规则内容",
      "displayRule": "显示用规则"
    }
  }
}
```

**向后兼容处理：**
```
文件格式检测
├── 新格式：包含 globalSets 和 rules 字段
├── 旧格式：直接是规则数据对象
└── 自动转换：旧格式转新格式加载
```

#### 3.3 现代文件API集成
**File System Access API 支持：**
- 原生文件选择器
- 直接文件系统访问
- 用户友好的保存体验

**降级兼容机制：**
```
API可用性检测
├── 支持 File System Access API
│   └── 使用现代文件选择器
└── 不支持现代API
    └── 降级到传统下载方式
```

**文件操作流程：**
```
用户操作 → API检测 → 文件选择器 → 数据处理 → 文件保存 → 结果反馈
```

### 4. 数据序列化与反序列化

#### 4.1 复杂数据结构处理
**Map 和 Set 序列化：**
```javascript
// Map<string, Set<string>> 序列化
Map → Array<[string, Array<string>]>

// 示例转换
localSets: Map {
  "元音" => Set {"a", "e", "i"}
}
↓
localSets: [["元音", ["a", "e", "i"]]]
```

**反序列化恢复：**
```javascript
// 数组格式恢复为Map和Set
Array<[string, Array<string>]> → Map<string, Set<string>>
```

#### 4.2 数据完整性保证
**序列化验证：**
- 数据类型检查
- 必要字段验证
- 循环引用检测

**反序列化安全：**
- JSON解析异常处理
- 数据格式验证
- 默认值填充

### 5. 导入导出功能

#### 5.1 规则导出系统
**导出功能特性：**
- 完整规则库导出
- 选择性规则导出
- 全局集合包含
- 元数据保留

**导出流程：**
```
选择导出内容 → 数据收集 → 格式转换 → 文件生成 → 保存到本地
```

**导出文件特点：**
- 人类可读的JSON格式
- 完整的数据结构
- 版本兼容性标识
- 导出时间戳

#### 5.2 规则导入系统
**导入功能特性：**
- 多格式兼容
- 智能数据合并
- 冲突处理机制
- 导入验证

**导入流程：**
```
文件选择 → 格式检测 → 数据解析 → 冲突处理 → 数据合并 → 状态更新
```

**冲突处理策略：**
- 同名规则：用户选择覆盖或跳过
- 集合冲突：智能合并或替换
- 格式不兼容：错误提示和修复建议

### 6. 数据同步与一致性

#### 6.1 跨页面数据同步
**同步机制：**
- localStorage 变更监听
- 自定义事件通知
- 页面间状态同步

**同步触发条件：**
```
数据变更事件
├── 规则增删改
├── 全局集合变更
├── 排序调整
└── 配置修改
```

**同步流程：**
```
数据变更 → 事件触发 → 跨页面通知 → 状态更新 → 界面刷新
```

#### 6.2 数据一致性保证
**一致性检查：**
- 启动时数据校验
- 操作前状态检查
- 定期一致性验证

**不一致处理：**
```
检测到不一致
├── 轻微不一致：自动修复
├── 严重不一致：用户选择
└── 无法修复：重置提示
```

### 7. 性能优化策略

#### 7.1 存储性能优化
**写入优化：**
- 批量写入机制
- 防抖动保存
- 增量更新策略

**读取优化：**
- 懒加载机制
- 缓存策略
- 预加载关键数据

#### 7.2 内存管理优化
**内存使用控制：**
- 及时释放临时数据
- 大数据分片处理
- 内存泄漏防护

**缓存策略：**
```
缓存层级
├── 一级缓存：内存中的活跃数据
├── 二级缓存：localStorage中的持久数据
└── 三级缓存：文件中的备份数据
```

### 8. 错误处理与恢复

#### 8.1 错误分类处理
**存储错误类型：**

**配额超限错误：**
- 检测存储空间
- 清理过期数据
- 提示用户处理

**数据损坏错误：**
- 自动备份恢复
- 部分数据救援
- 重置确认机制

**网络相关错误：**
- 离线模式支持
- 数据缓存机制
- 同步重试策略

#### 8.2 数据恢复机制
**恢复策略层级：**
```
数据恢复流程
├── 自动恢复：从备份数据恢复
├── 半自动恢复：用户确认后恢复
├── 手动恢复：用户选择恢复方式
└── 重置恢复：恢复到初始状态
```

**备份策略：**
- 关键操作前自动备份
- 定期增量备份
- 用户手动备份

## 数据流转流程图

```
用户操作
    ↓
内存数据变更
    ↓
变更检测与验证
    ↓
数据序列化
    ↓
localStorage 保存
    ├── 成功 → 状态同步
    └── 失败 → 错误处理
    ↓
跨页面同步通知
    ↓
界面状态更新
    ↓
用户反馈

文件导出流程：
用户触发导出
    ↓
收集当前数据
    ↓
数据格式转换
    ↓
文件生成
    ↓
保存到本地
    ↓
操作结果反馈

文件导入流程：
用户选择文件
    ↓
文件格式检测
    ↓
数据解析验证
    ↓
冲突检测处理
    ↓
数据合并更新
    ↓
同步到存储
    ↓
界面刷新
```

## 技术特色

### 1. 多层次存储架构
- 内存、本地存储、文件系统三层设计
- 不同数据类型的最优存储策略
- 灵活的数据迁移和备份机制

### 2. 智能数据管理
- 自动序列化复杂数据结构
- 向后兼容的文件格式设计
- 智能冲突检测和处理

### 3. 现代API集成
- File System Access API 支持
- 优雅的降级兼容机制
- 用户友好的文件操作体验

### 4. 可靠的数据保护
- 多重备份策略
- 完善的错误恢复机制
- 数据完整性验证

## 应用场景

### 个人使用
- 规则库个人备份
- 设备间数据迁移
- 长期数据保存

### 团队协作
- 规则库共享
- 标准规则分发
- 团队配置同步

### 教育培训
- 课程资料分发
- 学生作业收集
- 教学资源管理

### 研究项目
- 研究数据备份
- 实验配置保存
- 结果数据归档

## 待优化功能

### 1. 云端同步支持
- 云存储集成
- 多设备自动同步
- 版本历史管理

### 2. 高级备份功能
- 自动定时备份
- 增量备份优化
- 备份压缩和加密

### 3. 数据分析功能
- 使用统计分析
- 数据使用报告
- 性能监控面板

### 4. 协作功能增强
- 实时协作编辑
- 变更历史追踪
- 权限管理系统

该系统通过多层次的存储架构和智能的数据管理机制，为用户提供了可靠、高效的数据持久化解决方案，确保用户数据的安全性和可用性，同时支持灵活的数据迁移和共享需求。

该系统通过多层次的存储架构和智能的数据管理机制，为用户提供了可靠、高效的数据持久化解决方案，确保用户数据的安全性和可用性，同时支持灵活的数据迁移和共享需求。