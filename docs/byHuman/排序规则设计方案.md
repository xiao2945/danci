# 排序规则设计方案

## 概述

本文档定义了单词筛选工具的排序规则设计方案，支持基于位置标识符的灵活排序策略，允许最多三级排序以支持复杂的音韵和词汇分析需求。

## 核心设计原则

1. **位置灵活性**：支持前缀、后缀、任意位置、严格中间等多种位置匹配策略
2. **顺序关系**：多个排序元素之间隐含前后关系，前一个元素在后一个元素之前（不要求紧邻）
3. **层级支持**：支持最多三级排序，满足复杂分析需求
4. **统一策略**：移除特殊处理逻辑，所有集合使用统一的匹配策略

## 位置标识符定义

| 标识符 | 名称 | 描述 | 示例 |
|--------|------|------|------|
| `^` | 前缀匹配 | 元素必须出现在单词开头 | `V^` 匹配以元音开头的单词 |
| `$` | 后缀匹配 | 元素必须出现在单词结尾 | `C$` 匹配以辅音结尾的单词 |
| `*` | 任意位置 | 元素可以出现在单词任意位置 | `V*` 匹配包含元音的单词 |
| `~` | 严格中间 | 元素必须出现在单词中间（不在首尾） | `V~` 匹配中间包含元音但首尾不是元音的单词 |
| 无标识符 | 默认前缀 | 等同于 `^`，向后兼容 | `V` 等同于 `V^` |

## 语法格式

### 基本语法
```
@(集合名位置标识符)(集合名位置标识符)...
```

### 语法规则
1. 以 `@` 开头表示排序规则
2. 每个排序元素由集合名和位置标识符组成
3. 多字母集合名需要用括号包围：`(BL^)`
4. 单字母集合可以直接使用：`V^` 或 `(V^)`
5. 可选的逆序标志 `-` 放在集合名前：`(-V^)` 或 `-V^`
6. 最多支持三级排序

## 匹配逻辑

### 单个集合匹配

对于排序规则 `@V^`：
1. 遍历集合 V 中的每个元素（如 a, e, i, o, u）
2. 检查单词是否以该元素开头
3. 按集合中元素的顺序创建分组标签
4. 未匹配的单词归入"其他"分组

### 多个集合顺序匹配

对于排序规则 `@(BL^)(V*)`：
1. **第一级**：按 BL 集合的前缀匹配进行分组
2. **第二级**：在每个第一级分组内，按 V 集合的任意位置匹配进行分组
3. **匹配条件**：单词必须同时满足所有级别的匹配条件
   - 以 BL 中某个元素开头 AND 包含 V 中某个元素

### 三级排序示例

`@(BL^)(V*)(C$)` 表示：
1. 第一级：以 BL 集合元素开头
2. 第二级：包含 V 集合元素
3. 第三级：以 C 集合元素结尾

## 分组标签生成

### 标签格式
- **单级**：`集合元素` （如："a", "bl"）
- **多级**：`一级标签 > 二级标签` （如："bl > a"）
- **三级**：`一级标签 > 二级标签 > 三级标签` （如："bl > a > t"）

### 标签顺序
- 按集合中元素的定义顺序排列
- 逆序标志影响该级别的排序方向
- "其他"分组始终排在最后

## 特殊情况处理

### 1. 无匹配元素
- 单词不满足任何排序条件时，归入"其他"分组
- "其他"分组内的单词按字母顺序排列

### 2. 部分匹配
- 多级排序中，单词必须满足所有级别的条件才能被分组
- 不满足某一级条件的单词归入"其他"分组

### 3. 多个匹配
- 单词可能匹配集合中的多个元素
- 按集合中元素的顺序，使用第一个匹配的元素作为分组依据

## 实际应用示例

### 示例1：音韵结构分析
```
# 分析辅音群+元音+辅音结构
@(BL^)(V*)(C$)
```

可能的分组：
- bl > a > t: "blast", "black"
- br > e > d: "bread", "bred"
- cl > i > p: "clip", "clipped"

### 示例2：元音位置分析
```
# 分析单词中间包含特定元音的情况
@(V~)
```

匹配单词中间包含元音但首尾不是元音的单词：
- a: "cat", "bat" (c-a-t, b-a-t)
- e: "bed", "red" (b-e-d, r-e-d)

### 示例3：复杂音素组合
```
# 三级排序：起始辅音群+中间元音+结尾类型
@(BL^)(ShortV*)(EndType$)
```

其中：
- BL: {bl, br, cl, cr, dr, fl, fr, gl, gr, pl, pr}
- ShortV: {a, e, i, o} (短元音，排除u)
- EndType: {t, d, k, p} (爆破音结尾)

## 实现指南与最佳实践

### 1. 规则设计建议
**位置标识符选择：**
- `^` 用于明确的前缀要求
- `$` 用于明确的后缀要求
- `*` 用于灵活的位置匹配
- `~` 用于严格的中间位置

**组合策略：**
- 从简单的单级排序开始
- 逐步增加排序层级
- 合理使用位置标识符

### 2. 性能优化建议
**算法效率：**
- 避免过度复杂的位置组合
- 合理设计匹配顺序
- 利用缓存机制提升性能

**数据处理：**
- 大数据集建议分批处理
- 预处理常用匹配模式
- 优化内存使用策略

### 3. 错误预防与调试
**常见错误：**
- 位置标识符使用不当
- 集合引用错误
- 排序层级过深

**调试技巧：**
- 分步测试排序规则
- 验证位置匹配结果
- 检查分组标签生成

### 4. 兼容性考虑
**向后兼容：**
- 无标识符规则默认前缀匹配
- 保持现有分组标签格式
- 支持渐进式规则升级

**迁移策略：**
- 现有规则无需修改即可使用
- 新功能作为可选扩展
- 提供规则转换工具