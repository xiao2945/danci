# 单词工具开发实施计划

## 计划概述
基于2025年5月30日的需求分析，制定详细的开发实施计划，包括版本规划、技术方案和时间安排。

## 版本规划

### v1.0.3 - 核心功能增强版
**预计发布时间：** 2025年6月15日
**主要功能：**

#### 1. 筛选结果预处理（删除）功能 ✅ **已完成**
**技术方案：**
```javascript
// 扩展结果数据结构
interface WordResult {
  word: string;
  phonetic?: string;
  deleted: boolean;  // 新增删除状态
  originalIndex: number; // 原始索引
}

// UI组件结构
<div class="word-item ${deleted ? 'deleted' : ''}">
  <span class="word-text">${word}</span>
  <button class="delete-btn" onclick="toggleDelete(index)">
    ${deleted ? '↶' : '×'}
  </button>
</div>
```

**实现步骤：**
1. 修改数据结构，添加deleted字段
2. 更新UI组件，添加删除/恢复按钮
3. 实现删除状态切换逻辑
4. 更新统计显示（显示删除数量）
5. 修改导出逻辑，过滤已删除单词
6. 添加批量操作功能（全选删除/恢复）

#### 2. 规则注释功能 ✅ **已完成**
**技术方案：**
```javascript
// 扩展规则数据结构
interface Rule {
  name: string;
  comment?: string;  // 新增注释字段
  code: string;
  order: number;
  createdAt: Date;
  updatedAt: Date;
}

// 注释显示组件
<div class="rule-comment">
  <input type="text" 
         placeholder="// 规则注释（可选，最多60字符）"
         maxlength="60"
         value="${comment || ''}"
         onchange="updateComment(ruleId, this.value)">
</div>
```

**实现步骤：**
1. 扩展规则数据结构
2. 在规则创建/编辑界面添加注释输入框
3. 在规则预览、列表等位置显示注释
4. 实现注释的截取显示逻辑
5. 更新导出功能，包含注释信息

#### 3. 组合规则非模式 ✅ **已完成**
**技术方案：**
```javascript
// 新增非操作符 "--"
class RuleEngine {
  parseRule(ruleCode) {
    // 解析 condition1 -- condition2
    // 转换为 condition1 && !(condition2)
    return ruleCode.replace(
      /(.*?)\s*--\s*(.*)/g, 
      '($1) && !($2)'
    );
  }
}

// 使用示例
const rule = "word.includes('[aeiou]') -- word.startsWith('[aeiou]')";
// 解析为：包含元音但不以元音开头
```

**实现步骤：**
1. 扩展规则解析器，支持"--"操作符
2. 更新规则验证逻辑
3. 在规则编辑器中添加"--"按钮
4. 更新文档和范例
5. 添加相关测试用例

### v1.0.4 - 界面优化版
**预计发布时间：** 2025年7月1日
**主要功能：**

#### 1. 已保存规则布局优化
**技术方案：**
```css
/* 响应式网格布局 */
.saved-rules-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
  padding: 16px;
}

/* 窄屏适配 */
@media (max-width: 768px) {
  .saved-rules-container {
    grid-template-columns: 1fr;
  }
}

/* 拖拽状态 */
.rule-item.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}
```

#### 2. 规则拖拽排序功能
**技术方案：**
```javascript
// 集成SortableJS
import Sortable from 'sortablejs';

class RuleManager {
  initDragSort() {
    const container = document.getElementById('saved-rules');
    Sortable.create(container, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: (evt) => {
        this.updateRuleOrder(evt.oldIndex, evt.newIndex);
      }
    });
  }
  
  updateRuleOrder(oldIndex, newIndex) {
    const rules = this.getRules();
    const [movedRule] = rules.splice(oldIndex, 1);
    rules.splice(newIndex, 0, movedRule);
    
    // 更新order字段
    rules.forEach((rule, index) => {
      rule.order = index;
    });
    
    this.saveRules(rules);
    this.syncToMainPage(); // 同步到主页选择框
  }
}
```

#### 3. 范例显示优化
**技术方案：**
```javascript
// 代码高亮和格式化
import Prism from 'prismjs';

class ExampleManager {
  formatCode(code) {
    // 格式化规则代码
    const formatted = this.prettifyRule(code);
    return Prism.highlight(formatted, Prism.languages.javascript, 'javascript');
  }
  
  prettifyRule(code) {
    return code
      .replace(/&&/g, ' && ')
      .replace(/\|\|/g, ' || ')
      .replace(/--/g, ' -- ')
      .replace(/\s+/g, ' ')
      .trim();
  }
}
```

### v1.0.5 - 功能完善版
**预计发布时间：** 2025年7月15日
**主要功能：**

#### 1. 规则验证和提示系统
```javascript
class RuleValidator {
  validateRule(ruleCode) {
    const errors = [];
    const warnings = [];
    
    // 语法检查
    try {
      new Function('word', `return ${ruleCode}`);
    } catch (e) {
      errors.push(`语法错误: ${e.message}`);
    }
    
    // 逻辑检查
    if (ruleCode.includes('word.length === 0')) {
      warnings.push('匹配空字符串可能不是预期行为');
    }
    
    return { errors, warnings, valid: errors.length === 0 };
  }
  
  getSuggestions(partialCode) {
    const suggestions = [
      { text: 'word.length >= ', description: '最小长度限制' },
      { text: 'word.length <= ', description: '最大长度限制' },
      { text: '\\-b[', description: '词首匹配' },
      { text: '\\-e[', description: '词尾匹配' },
      { text: '\\m[', description: '中间匹配' }
    ];
    
    return suggestions.filter(s => 
      s.text.toLowerCase().includes(partialCode.toLowerCase())
    );
  }
}
```

#### 2. 测试规则单词库扩展
```javascript
const EXTENDED_TEST_WORDS = [
  // 基础单词
  'cat', 'dog', 'run', 'big', 'red',
  // 中等长度
  'apple', 'house', 'water', 'green', 'happy',
  // 长单词
  'elephant', 'beautiful', 'important', 'information',
  // 特殊模式
  'running', 'walked', 'swimming', 'played',
  // 复杂单词
  'extraordinary', 'incomprehensible'
];
```

## 技术实施细节

### 数据迁移策略
```javascript
class DataMigration {
  migrateToV103() {
    const rules = this.getRules();
    const migratedRules = rules.map((rule, index) => ({
      ...rule,
      comment: rule.comment || '',
      order: rule.order || index,
      version: '1.0.3'
    }));
    
    this.saveRules(migratedRules);
  }
  
  migrateResults() {
    // 为现有结果添加deleted字段
    const results = this.getStoredResults();
    if (results && !results[0]?.hasOwnProperty('deleted')) {
      const migratedResults = results.map(result => ({
        ...result,
        deleted: false
      }));
      this.saveResults(migratedResults);
    }
  }
}
```

### 性能优化策略
```javascript
class PerformanceOptimizer {
  // 虚拟滚动优化大量结果显示
  implementVirtualScroll() {
    const ITEM_HEIGHT = 40;
    const VISIBLE_ITEMS = Math.ceil(window.innerHeight / ITEM_HEIGHT);
    
    return {
      startIndex: Math.floor(scrollTop / ITEM_HEIGHT),
      endIndex: Math.min(startIndex + VISIBLE_ITEMS, totalItems),
      offsetY: startIndex * ITEM_HEIGHT
    };
  }
  
  // 规则编译缓存
  cacheCompiledRules() {
    const cache = new Map();
    
    return function compileRule(ruleCode) {
      if (!cache.has(ruleCode)) {
        const compiled = new Function('word', `return ${ruleCode}`);
        cache.set(ruleCode, compiled);
      }
      return cache.get(ruleCode);
    };
  }
}
```

### 测试策略
```javascript
// 单元测试
describe('RuleEngine', () => {
  test('should handle non-operator correctly', () => {
    const engine = new RuleEngine();
    const rule = "word.includes('a') -- word.startsWith('a')";
    const result = engine.applyRule(['cat', 'apple', 'dog'], rule);
    expect(result).toEqual(['cat']); // 包含a但不以a开头
  });
});

// 集成测试
describe('Word Deletion Feature', () => {
  test('should exclude deleted words from export', () => {
    const words = [{ word: 'cat', deleted: false }, { word: 'dog', deleted: true }];
    const exported = exportToText(words);
    expect(exported).not.toContain('dog');
  });
});
```

## 风险控制

### 1. 数据安全
- 实施数据备份机制
- 版本迁移前自动备份
- 提供数据恢复功能

### 2. 兼容性保证
- 保持API向后兼容
- 渐进式功能启用
- 降级方案准备

### 3. 性能监控
- 添加性能指标收集
- 监控大数据集处理性能
- 优化关键路径

## 发布检查清单

### v1.0.3 发布前检查
- [ ] 删除功能完整测试
- [ ] 注释功能各场景验证
- [ ] 非操作符逻辑正确性
- [ ] 数据迁移脚本测试
- [ ] 导出功能兼容性
- [ ] 性能回归测试
- [ ] 文档更新完成
- [ ] 用户手册更新

### 质量标准
- 代码覆盖率 > 80%
- 关键功能测试通过率 100%
- 性能不低于当前版本
- 内存泄漏检查通过
- 跨浏览器兼容性验证

## 后续规划

### v1.1.0 - 高级功能版
- 音标匹配功能
- 词性标注集成
- 语义搜索功能
- 云端规则库

### v1.2.0 - 智能化版
- AI辅助规则生成
- 智能推荐系统
- 学习进度跟踪
- 个性化定制

## 总结

本实施计划采用渐进式开发策略，优先实现核心功能，逐步完善用户体验。每个版本都有明确的目标和验收标准，确保项目稳步推进。重点关注数据安全、性能优化和用户体验，为后续的高级功能奠定坚实基础。